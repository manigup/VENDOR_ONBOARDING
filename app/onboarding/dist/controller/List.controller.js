sap.ui.define(["./BaseController","sap/m/MessageBox","sap/m/MessageToast","sap/ui/model/Filter","sap/ui/core/BusyIndicator","sap/ui/model/json/JSONModel"],function(e,t,o,a,r,s){"use strict";return e.extend("sp.fiori.onboarding.controller.List",{onInit:function(){this.getRouter().attachRoutePatternMatched(this.onRouteMatched,this);["createFromDateId","createToDateId"].forEach(e=>{this.byId(e).attachBrowserEvent("keypress",e=>e.preventDefault())})},onRouteMatched:function(e){if(e.getParameter("name")!=="list"){return}this.getView().setModel(new s([]),"FormData");this.getData()},getData:function(){r.show();setTimeout(()=>{this.getView().getModel().read("/VenOnboard",{success:e=>{e.results.map(e=>{e.StatusText=formatter.formatStatus(e.Status);e.WavStatusText=formatter.formatStatus(e.WavStatus);parseInt(e.Score);return e});var t={supplychain:false,finance:false};var o=this.getView().getModel("AccessDetails").getData();var a=this.getView().getModel("UserApiDetails").getData();t.supplychain=o.find(e=>e.email===a.email&&e.Access==="SCM")?true:false;t.finance=o.find(e=>e.email===a.email&&e.Access==="Finance")?true:false;if(t.supplychain){t.appbtn="supply"}else if(t.finance){t.appbtn="finance"}this.getView().getModel("request").setData(t);this.getView().getModel("request").refresh(true);this.getView().getModel("DataModel").setData(e.results);this.getView().getModel("DataModel").setSizeLimit(e.results.length);this.getView().getModel("DataModel").refresh(true);r.hide()},error:()=>r.hide()})},1e3)},onSearch:function(e){var t=e.getParameter("query");if(e.getParameter("refreshButtonPressed")){this.getData()}else if(t){this.byId("createFromDateId").setValue("");this.byId("createToDateId").setValue("");this.byId("vendorList").getBinding("items").filter([new a([new a("Vendor",sap.ui.model.FilterOperator.Contains,t),new a("VendorName",sap.ui.model.FilterOperator.Contains,t),new a("Lifnr",sap.ui.model.FilterOperator.Contains,t),new a("VenApprovalPending",sap.ui.model.FilterOperator.Contains,t),new a("StatusText",sap.ui.model.FilterOperator.Contains,t)])])}else{this.byId("vendorList").getBinding("items").filter([])}},onCreationDateFilter:function(){var e=this.byId("createFromDateId").getValue(),t=this.byId("createToDateId").getValue();if(e&&t){this.byId("vendorList").getBinding("items").filter([new a([new a("createdAt",sap.ui.model.FilterOperator.BT,e,t)])])}else if(e){this.byId("vendorList").getBinding("items").filter([new a([new a("createdAt",sap.ui.model.FilterOperator.EQ,e)])])}else if(t){this.byId("vendorList").getBinding("items").filter([new a([new a("createdAt",sap.ui.model.FilterOperator.LE,t)])])}else{this.byId("vendorList").getBinding("items").filter([])}this.byId("search").setValue("")},onCreatePress:function(){var e=sap.ui.xmlfragment("sp.fiori.onboarding.fragment.Create",this);this.getView().addDependent(e);sap.ui.getCore().byId("createDialog").setModel(new s({}),"CreateModel");e.open()},onCreateSubmit:function(){if(this.validateFields()){r.show();const e=sap.ui.getCore().byId("createDialog").getModel("CreateModel").getData();e.Vendor=this.generateVendorNo();e.VenFrom=new Date;e.VenValidTo=this.changeDate(e.VenFrom,7,"add");setTimeout(()=>{this.getView().getModel().create("/VenOnboard",e,{success:e=>{r.hide();console.log("VendorId",e.VendorId);t.success("Vendor creation request "+e.Vendor+" created successfully. \n\n Also, Supplier form generated please fill to procced.",{onClose:()=>{sap.ui.getCore().byId("createDialog").destroy();this.getData()}});this.sendEmailNotification(e.VendorId,e.VendorMail)},error:()=>r.hide()})},1e3)}else{t.error("Please correct all the error's to proceed")}},sendEmailNotification:function(e,t){var o="https://impautosuppdev.launchpad.cfapps.ap10.hana.ondemand.com/a1aa5e6e-4fe2-49a5-b95a-5cd7a2b05a51.onboarding.spfiorisupplierform-0.0.1/index.html?id="+e;var a=this.getView().getModel();var r={method:"GET",urlParameters:{subject:"Supplier Form",content:o,toAddress:t},success:function(e,t){console.log("Email sent successfully.")},error:function(e){console.log("Failed to send email.")}};a.callFunction("/sendEmail",r)},onFormPress:function(){const e=window.location.href;let t;if(e.includes("impautosuppdev")){t="https://impautosuppdev.launchpad.cfapps.ap10.hana.ondemand.com/a1aa5e6e-4fe2-49a5-b95a-5cd7a2b05a51.onboarding.spfiorisupplierform-0.0.1/index.html?id="+this.vendorId}else{t="/supplierform/webapp/index.html?id="+this.vendorId}window.open(t)},onMoreInfoPress:function(e){e.getSource().getParent().getParent().destroy();this.getRouter().navTo("Form",{VendorId:this.vendorId})},onVendorPress:function(e){var t=e.getSource().getBindingContext("DataModel").getObject();var o=this.getView().getModel("request").getData();this.vendor=t.Vendor;this.vendorId=t.VendorId;if(o.supplychain===true){t.Access="SCM"}else if(o.finance===true){t.Access="Finance"}var a=sap.ui.xmlfragment("sp.fiori.onboarding.fragment.VendorDetails",this);sap.ui.getCore().byId("displayPopover").setModel(new s(t),"VenModel");this.getView().addDependent(a);a.openBy(e.getSource())},onResetValidityPress:function(e){r.show();var o=e.getSource();var a=this.getView().getModel("DataModel").getData();var s={};for(var i=0;i<a.length;i++){if(a[i].VendorId===this.vendorId){s.Vendor=a[i].Vendor;s.VendorId=a[i].VendorId;s.VendorName=a[i].VendorName;s.VendorType=a[i].VendorType;s.Department=a[i].Department;s.Telephone=a[i].Telephone;s.City=a[i].City;s.VendorMail=a[i].VendorMail;s.VenFrom=new Date;s.VenValidTo=this.changeDate(s.VenFrom,7,"add");s.VenTimeLeft="";s.Status=a[i].Status;s.ResetValidity="";break}}setTimeout(()=>{this.getView().getModel().update("/VenOnboard(Vendor='"+s.Vendor+"',VendorId="+this.vendorId+")",s,{success:()=>{r.hide();t.success("Form validity extended for next 7 days for vendor "+this.vendor,{onClose:()=>{o.getParent().getParent().destroy();this.getData()}})},error:e=>{r.hide();console.log(e)}})},1e3)},onAttachmentPress:function(e){r.show();var t=e.getSource();this.vendorId=t.getBindingContext("DataModel").getProperty("VendorId");setTimeout(()=>{this.getView().getModel().read("/Attachments",{filters:[new a("VendorId","EQ",this.vendorId)],success:e=>{e.results.map(e=>e.Url=this.getView().getModel().sServiceUrl+"/Attachments(VendorId='"+e.VendorId+"',ObjectId='"+e.ObjectId+"')/$value");var o=sap.ui.xmlfragment("sp.fiori.onboarding.fragment.Attachment",this);sap.ui.getCore().byId("attachPopover").setModel(new s(e),"AttachModel");this.getView().addDependent(o);o.openBy(t);sap.ui.getCore().byId("attachment").setUploadUrl(this.getView().getModel().sServiceUrl+"/Attachments");r.hide()},error:()=>r.hide()})},1e3)},onBeforeUploadStartsAttach:function(e){r.show();e.getParameters().addHeaderParameter(new sap.m.UploadCollectionParameter({name:"slug",value:this.vendorId+"/"+e.getParameters().fileName}))},getAttachments:function(){r.show();setTimeout(()=>{this.getView().getModel().read("/Attachments",{filters:[new a("VendorId","EQ",this.vendorId)],success:e=>{e.results.map(e=>e.Url=this.getView().getModel().sServiceUrl+"/Attachments(VendorId='"+e.VendorId+"',ObjectId='"+e.ObjectId+"')/$value");sap.ui.getCore().byId("attachPopover").setModel(new s(e),"AttachModel");r.hide()},error:()=>r.hide()})},1e3)},onAttachmentUploadComplete:function(e){if(e.getParameter("files")[0].status==201){o.show("File "+e.getParameter("files")[0].fileName+" Attached successfully");this.getAttachments()}else{t.error(JSON.parse(e.getParameter("files")[0].responseRaw).error.message.value);r.show()}},onAttachmentDeletePress:function(e){var o=e.getSource().getBindingContext("AttachModel").getObject();t.confirm("Are you sure ?",{actions:[t.Action.YES,t.Action.NO],onClose:e=>{if(e==="YES"){r.show();setTimeout(()=>{this.getView().getModel().remove("/Attachments(VendorId='"+o.VendorId+"',ObjectId='"+o.ObjectId+"')",{success:()=>{r.hide();t.success(o.Filename+" deleted successfully",{onClose:()=>this.getAttachments()})},error:()=>r.hide()})},1e3)}}})},changeStatus:function(e){var o=this.getView().getModel("DataModel").getData();var a={};for(var s=0;s<o.length;s++){if(o[s].VendorId===this.vendorId){a.Vendor=o[s].Vendor;a.VendorId=o[s].VendorId;a.VendorName=o[s].VendorName;a.VendorType=o[s].VendorType;a.Department=o[s].Department;a.Telephone=o[s].Telephone;a.City=o[s].City;a.VendorMail=o[s].VendorMail;a.VenValidTo=o[s].VenValidTo;a.VenFrom=o[s].VenFrom;a.VenTimeLeft=o[s].VenTimeLeft;var i=o[s].Status;a.ResetValidity=o[s].ResetValidity;break}}var n="";var d="";var l="";var c="0";if(i==="SBF"){n="SCA";c="1";d="2";l="Finance";this.msg="Approved by Supply Chain"}else if(i==="SCA"){n="ABF";a.BusinessPartnerNo=e;this.msg="Approved by Finance and BP "+a.BusinessPartnerNo+" created successfully"}a.Status=n;a.VenLevel=d;a.VenApprovalPending=l;a.VenApprove=c;this.getView().getModel().update("/VenOnboard(Vendor='"+a.Vendor+"',VendorId="+this.vendorId+")",a,{success:()=>{r.hide();t.success(this.msg,{onClose:()=>this.getData()})},error:e=>{r.hide();console.log(e)}})},getFormData:function(){var e=this.getView().getModel("DataModel").getData();var o=this.getView().getModel("FormData").getData();if(o.ExciseDivision===""){o.ExciseDivision="-"}if(o.ExciseBankAcc===""){o.ExciseBankAcc="-"}if(o.STRatePerc===""){o.STRatePerc="0"}if(o.JWRWCost===""){o.JWRWCost="0"}if(o.ExciseRange===""){o.ExciseRange="0"}if(o.ExciseBankName===""){o.ExciseBankName="-"}if(o.STRateSurcharge===""){o.STRateSurcharge="0"}if(o.LSTNo===""){o.LSTNo="0"}o.TransMode="";var a="https://imperialauto.co/IAIAPI.asmx/PostSupplierMaster";$.ajax({type:"POST",contentType:"application/json",url:a,data:o,context:this,success:function(e,t,o){this.changeStatus(e[0].SuccessCode)}.bind(this),error:function(e){t.success("BP creation failed")}})},onApprPress:function(e){var o=this.getView().getModel("DataModel").getData();var a=e.getSource().getBindingContext("DataModel").sPath.split("/")[1];this.vendorId=o[a].VendorId;var s=o[a].Status;if(s==="SCA"){setTimeout(()=>{this.getView().getModel().read("/VendorForm(VendorId='"+this.vendorId+"')",{success:e=>{this.getView().getModel("FormData").setData(e);var o=this.getView().getModel("AccessDetails").getData();this.compcodecheck=o.find(t=>t.CompCode===e.Bukrs)?true:false;this.compcodecheck=true;r.hide();if(this.compcodecheck){this.getFormData()}else{t.error("User does not belong to company code "+e.Bukrs+" and hence cannot approve")}},error:()=>{r.hide()}})},1e3)}else if(s==="SBF"){setTimeout(()=>{this.getView().getModel().read("/VendorForm(VendorId='"+this.vendorId+"')",{success:e=>{this.getView().getModel("FormData").setData(e);var o=this.getView().getModel("AccessDetails").getData();this.compcodecheck=o.find(t=>t.CompCode===e.Bukrs)?true:false;this.compcodecheck=true;r.hide();if(this.compcodecheck){this.changeStatus()}else{t.error("User does not belong to company code "+e.Bukrs+" and hence cannot approve")}},error:()=>{r.hide()}})},1e3)}},onRejPress:function(e){var o=this.getView().getModel("DataModel").getData();var a=e.getSource().getBindingContext("DataModel").sPath.split("/")[1];this.vendorId=o[a].VendorId;var s={};for(var i=0;i<o.length;i++){if(o[i].VendorId===this.vendorId){s.Vendor=o[i].Vendor;s.VendorId=o[i].VendorId;s.VendorName=o[i].VendorName;s.VendorType=o[i].VendorType;s.Department=o[i].Department;s.Telephone=o[i].Telephone;s.City=o[i].City;s.VendorMail=o[i].VendorMail;s.VenValidTo=o[i].VenValidTo;s.VenFrom=o[i].VenFrom;s.VenTimeLeft=o[i].VenTimeLeft;var n=o[i].Status;s.ResetValidity=o[i].ResetValidity;break}}var d="";var l="";var c="";var h="0";if(n==="SBF"){d="SCR";this.msg="Rejected successfully by Supply Chain"}else if(n==="SCA"){d="RBF";this.msg="Rejected successfully by Finance"}s.Status=d;s.VenLevel=l;s.VenApprovalPending=c;s.VenApprove=h;this.getView().getModel().update("/VenOnboard(Vendor='"+s.Vendor+"',VendorId="+this.vendorId+")",s,{success:()=>{t.success(this.msg,{onClose:()=>this.getData()})},error:e=>{r.hide();console.log(e)}})}})});