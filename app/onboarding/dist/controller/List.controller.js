sap.ui.define(["./BaseController","sap/m/MessageBox","sap/m/MessageToast","sap/ui/model/Filter","sap/ui/core/BusyIndicator","sap/ui/model/json/JSONModel"],function(e,t,o,a,r,i){"use strict";return e.extend("sp.fiori.onboarding.controller.List",{onInit:function(){this.getRouter().attachRoutePatternMatched(this.onRouteMatched,this);["createFromDateId","createToDateId"].forEach(e=>{this.byId(e).attachBrowserEvent("keypress",e=>e.preventDefault())})},onRouteMatched:function(e){if(e.getParameter("name")!=="list"){return}this.getView().setModel(new i([]),"FormData");this.getData()},getData:function(){r.show();setTimeout(()=>{this.getView().getModel().read("/VenOnboard",{success:e=>{e.results.map(e=>{e.StatusText=formatter.formatStatus(e.Status);e.WavStatusText=formatter.formatStatus(e.WavStatus);parseInt(e.Score);return e});var t={supplychain:false,finance:false};var o=this.getView().getModel("AccessDetails").getData();var a=this.getView().getModel("UserApiDetails").getData();t.supplychain=o.find(e=>e.email===a.email&&e.Access==="SCM")?true:false;t.finance=o.find(e=>e.email===a.email&&e.Access==="Finance")?true:false;t.supplychain=true;if(t.supplychain){t.appbtn="supply"}else if(t.finance){t.appbtn="finance"}this.getView().getModel("request").setData(t);this.getView().getModel("request").refresh(true);this.getView().getModel("DataModel").setData(e.results);this.getView().getModel("DataModel").setSizeLimit(e.results.length);this.getView().getModel("DataModel").refresh(true);r.hide()},error:()=>r.hide()})},1e3)},onSearch:function(e){var t=e.getParameter("query");if(e.getParameter("refreshButtonPressed")){this.getData()}else if(t){this.byId("createFromDateId").setValue("");this.byId("createToDateId").setValue("");this.byId("vendorList").getBinding("items").filter([new a([new a("Vendor",sap.ui.model.FilterOperator.Contains,t),new a("VendorName",sap.ui.model.FilterOperator.Contains,t),new a("Lifnr",sap.ui.model.FilterOperator.Contains,t),new a("VenApprovalPending",sap.ui.model.FilterOperator.Contains,t),new a("StatusText",sap.ui.model.FilterOperator.Contains,t)])])}else{this.byId("vendorList").getBinding("items").filter([])}},onCreationDateFilter:function(){var e=this.byId("createFromDateId").getValue(),t=this.byId("createToDateId").getValue();if(e&&t){this.byId("vendorList").getBinding("items").filter([new a([new a("createdAt",sap.ui.model.FilterOperator.BT,e,t)])])}else if(e){this.byId("vendorList").getBinding("items").filter([new a([new a("createdAt",sap.ui.model.FilterOperator.EQ,e)])])}else if(t){this.byId("vendorList").getBinding("items").filter([new a([new a("createdAt",sap.ui.model.FilterOperator.LE,t)])])}else{this.byId("vendorList").getBinding("items").filter([])}this.byId("search").setValue("")},onCreatePress:function(){var e=sap.ui.xmlfragment("sp.fiori.onboarding.fragment.Create",this);this.getView().addDependent(e);sap.ui.getCore().byId("createDialog").setModel(new i({}),"CreateModel");e.open()},onCreateSubmit:function(){if(this.validateFields()){r.show();const e=sap.ui.getCore().byId("createDialog").getModel("CreateModel").getData();e.Vendor=this.generateVendorNo();e.VenFrom=new Date;e.VenValidTo=this.changeDate(e.VenFrom,7,"add");setTimeout(()=>{this.getView().getModel().create("/VenOnboard",e,{success:e=>{r.hide();console.log("VendorId",e.VendorId);t.success("Vendor creation request "+e.Vendor+" created successfully. \n\n Also, Supplier form generated please fill to procced.",{onClose:()=>{sap.ui.getCore().byId("createDialog").destroy();this.getData()}});this.sendEmailNotification(e.VendorName,e.VendorId,e.VendorMail,e.VenValidTo)},error:()=>r.hide()})},1e3)}else{t.error("Please correct all the error's to proceed")}},sendEmailNotification:function(e,t,o,a){let r=`||Please find the link below for Vendor Assessment Form. Kindly log-in with the link to fill the form.<br><br>Form is valid till ${a}. Request you to fill the form and submit on time.<br><br><a href="https://impautosuppdev.launchpad.cfapps.ap10.hana.ondemand.com/da8bb600-97b5-4ae9-822d-e6aa134d8e1a.onboarding.spfiorisupplierform-0.0.1/index.html?id=${t}">CLICK HERE</a>`;var i=this.getView().getModel();var s={method:"GET",urlParameters:{vendorName:e,subject:"Supplier Form",content:r,toAddress:o},success:function(e,t){console.log("Email sent successfully.")},error:function(e){console.log("Failed to send email.")}};i.callFunction("/sendEmail",s)},onFormPress:function(){let e="http://localhost:4004/supplierform/webapp/index.html?id="+this.vendorId;window.open(e)},onMoreInfoPress:function(e){e.getSource().getParent().getParent().destroy();this.getRouter().navTo("Form",{VendorId:this.vendorId})},onVendorPress:function(e){var t=e.getSource().getBindingContext("DataModel").getObject();var o=this.getView().getModel("request").getData();this.vendor=t.Vendor;this.vendorId=t.VendorId;if(o.supplychain===true){t.Access="SCM"}else if(o.finance===true){t.Access="Finance"}var a=sap.ui.xmlfragment("sp.fiori.onboarding.fragment.VendorDetails",this);sap.ui.getCore().byId("displayPopover").setModel(new i(t),"VenModel");this.getView().addDependent(a);a.openBy(e.getSource())},onResetValidityPress:function(e){r.show();var o=e.getSource();var a=this.getView().getModel("DataModel").getData();var i={};for(var s=0;s<a.length;s++){if(a[s].VendorId===this.vendorId){i.Vendor=a[s].Vendor;i.VendorId=a[s].VendorId;i.VendorName=a[s].VendorName;i.VendorType=a[s].VendorType;i.Department=a[s].Department;i.Telephone=a[s].Telephone;i.City=a[s].City;i.VendorMail=a[s].VendorMail;i.VenFrom=new Date;i.VenValidTo=this.changeDate(i.VenFrom,7,"add");i.VenTimeLeft="";i.Status=a[s].Status;i.ResetValidity="";break}}setTimeout(()=>{this.getView().getModel().update("/VenOnboard(Vendor='"+i.Vendor+"',VendorId="+this.vendorId+")",i,{success:()=>{r.hide();t.success("Form validity extended for next 7 days for vendor "+this.vendor,{onClose:()=>{o.getParent().getParent().destroy();this.getData()}})},error:e=>{r.hide();console.log(e)}})},1e3)},onAttachmentPress:function(e){r.show();var t=e.getSource();this.vendorId=t.getBindingContext("DataModel").getProperty("VendorId");setTimeout(()=>{this.getView().getModel().read("/Attachments",{filters:[new a("VendorId","EQ",this.vendorId)],success:e=>{e.results.map(e=>e.Url=this.getView().getModel().sServiceUrl+"/Attachments(VendorId='"+e.VendorId+"',ObjectId='"+e.ObjectId+"')/$value");var o=sap.ui.xmlfragment("sp.fiori.onboarding.fragment.Attachment",this);sap.ui.getCore().byId("attachPopover").setModel(new i(e),"AttachModel");this.getView().addDependent(o);o.openBy(t);sap.ui.getCore().byId("attachment").setUploadUrl(this.getView().getModel().sServiceUrl+"/Attachments");r.hide()},error:()=>r.hide()})},1e3)},onBeforeUploadStartsAttach:function(e){r.show();e.getParameters().addHeaderParameter(new sap.m.UploadCollectionParameter({name:"slug",value:this.vendorId+"/"+e.getParameters().fileName}))},getAttachments:function(){r.show();setTimeout(()=>{this.getView().getModel().read("/Attachments",{filters:[new a("VendorId","EQ",this.vendorId)],success:e=>{e.results.map(e=>e.Url=this.getView().getModel().sServiceUrl+"/Attachments(VendorId='"+e.VendorId+"',ObjectId='"+e.ObjectId+"')/$value");sap.ui.getCore().byId("attachPopover").setModel(new i(e),"AttachModel");r.hide()},error:()=>r.hide()})},1e3)},onAttachmentUploadComplete:function(e){if(e.getParameter("files")[0].status==201){o.show("File "+e.getParameter("files")[0].fileName+" Attached successfully");this.getAttachments()}else{t.error(JSON.parse(e.getParameter("files")[0].responseRaw).error.message.value);r.show()}},onAttachmentDeletePress:function(e){var o=e.getSource().getBindingContext("AttachModel").getObject();t.confirm("Are you sure ?",{actions:[t.Action.YES,t.Action.NO],onClose:e=>{if(e==="YES"){r.show();setTimeout(()=>{this.getView().getModel().remove("/Attachments(VendorId='"+o.VendorId+"',ObjectId='"+o.ObjectId+"')",{success:()=>{r.hide();t.success(o.Filename+" deleted successfully",{onClose:()=>this.getAttachments()})},error:()=>r.hide()})},1e3)}}})},changeStatus:function(){var e=this.getView().getModel("DataModel").getData();var o=this.getView().getModel("FormData").getData();var a={};for(var i=0;i<e.length;i++){if(e[i].VendorId===this.vendorId){a.Vendor=e[i].Vendor;a.VendorId=e[i].VendorId;a.VendorName=e[i].VendorName;a.VendorType=e[i].VendorType;a.Department=e[i].Department;a.Telephone=e[i].Telephone;a.City=e[i].City;a.VendorMail=e[i].VendorMail;a.VenValidTo=e[i].VenValidTo;a.VenFrom=e[i].VenFrom;a.VenTimeLeft=e[i].VenTimeLeft;var s=e[i].Status;a.ResetValidity=e[i].ResetValidity;break}}var n="";var d="";var l="";var c="0";if(s==="SBF"){n="SCA";c="1";d="2";l="Finance";this.msg="Approved by Supply Chain"}else if(s==="SCA"){n="ABF";a.AddressCode=o.AddressCode;this.msg="Approved by Finance and BP "+a.BusinessPartnerNo+" created successfully"}a.Status=n;a.VenLevel=d;a.VenApprovalPending=l;a.VenApprove=c;this.getView().getModel().update("/VenOnboard(Vendor='"+a.Vendor+"',VendorId="+this.vendorId+")",a,{success:()=>{r.hide();t.success(this.msg,{onClose:()=>this.getData()})},error:e=>{r.hide();console.log(e)}})},getFormData:function(){var e=this.getView().getModel("DataModel").getData();var o=this.getView().getModel("FormData").getData();if(o.ExciseDivision===""){o.ExciseDivision="-"}if(o.ExciseBankAcc===""){o.ExciseBankAcc="-"}if(o.STRatePerc===""){o.STRatePerc="0"}if(o.JWRWCost===""){o.JWRWCost="0"}if(o.ExciseRange===""){o.ExciseRange="0"}if(o.ExciseBankName===""){o.ExciseBankName="-"}if(o.STRateSurcharge===""){o.STRateSurcharge="0"}if(o.LSTNo===""){o.LSTNo="0"}o.SupplierType="Permanent";o.UnitCode="P01";o.AddressCode="SDC-00-01";o.AccountCode="1201AOL002A";o.AccountDesc="A-ONE LOGISTICS";o.LeadTime="";o.IAIvendorCode="";o.Location="Within State";o.Designation="General Manager";o.DeliveryMode="Road";o.CustomerCat="OEM";o.ExciseDivision="-";o.ExciseBankAcc="-";o.STRatePerc="0";o.Tin="";o.Composite="0";o.CreditRating="";o.CreditRatingAgency="";o.ServiceAccType="";o.ECCNo="";o.LSTDate="";o.CSTDate="";o.ExciseNo="";o.JWRWCost="0";o.CompanyType="";o.ISOExpiryDate="";o.AddressType="OEM";o.ExciseRange="0";o.ExciseBankName="-";o.ExciseDuty="12";o.CinNo="U29299TN2006TTC061090";o.GstRegistered="1";o.GSTDate="10/JAN/1989";o.ServiceAccCode="";o.STRateSurcharge="0";o.CSTNo="822825";o.LSTNo="0";o.ExciseDate="";o.MRPPercentage="100";o.SalesPersonCode="";o.Distance="10";o.TypeOfSupplier="";o.GroupingLocation="INNHRFBD";o.GroupCode5="";o.GroupCode7="";o.Tax="CST00";o.GroupCode4="";o.ITransporters="";o.GroupCode8="";o.BankAddress="Nehru ground Faridabad";o.ContactPersonName="Mr. Rajeev Khatri";o.ContactPersonDepartment="PURCHASING";o.ContactPersonDesignation="G.M.";o.ContactPersonPhone="9956299740";o.ContactPersonMobile="9956299740";o.ContactPersonMail="rkhatri@impauto.com";o.SNo="1";o.DocCode="38";o.DocDescription="FORM 38";o.TransMode="ADD";o.CreatedBy="Manikandan";o.CreatedIP="";o.UpdatedBy="";var a="https://imperialauto.co:84/IAIAPI.asmx/PostSupplierMaster";$.ajax({type:"POST",contentType:"application/json",url:a,data:o,context:this,success:function(e,t,o){this.changeStatus()}.bind(this),error:function(e){t.success("BP creation failed")}})},onApprPress:function(e){var o=this.getView().getModel("DataModel").getData();var a=e.getSource().getBindingContext("DataModel").sPath.split("/")[1];this.vendorId=o[a].VendorId;var i=o[a].Status;if(i==="SCA"){setTimeout(()=>{this.getView().getModel().read("/VendorForm(VendorId='"+this.vendorId+"')",{success:e=>{this.getView().getModel("FormData").setData(e);var o=this.getView().getModel("AccessDetails").getData();this.compcodecheck=o.find(t=>t.CompCode===e.Bukrs)?true:false;this.compcodecheck=true;r.hide();if(this.compcodecheck){this.getFormData()}else{t.error("User does not belong to company code "+e.Bukrs+" and hence cannot approve")}},error:()=>{r.hide()}})},1e3)}else if(i==="SBF"){setTimeout(()=>{this.getView().getModel().read("/VendorForm(VendorId='"+this.vendorId+"')",{success:e=>{this.getView().getModel("FormData").setData(e);var o=this.getView().getModel("AccessDetails").getData();this.compcodecheck=o.find(t=>t.CompCode===e.Bukrs)?true:false;this.compcodecheck=true;r.hide();if(this.compcodecheck){this.changeStatus()}else{t.error("User does not belong to company code "+e.Bukrs+" and hence cannot approve")}},error:()=>{r.hide()}})},1e3)}},onRejPress:function(e){var o=this.getView().getModel("DataModel").getData();var a=e.getSource().getBindingContext("DataModel").sPath.split("/")[1];this.vendorId=o[a].VendorId;var i={};for(var s=0;s<o.length;s++){if(o[s].VendorId===this.vendorId){i.Vendor=o[s].Vendor;i.VendorId=o[s].VendorId;i.VendorName=o[s].VendorName;i.VendorType=o[s].VendorType;i.Department=o[s].Department;i.Telephone=o[s].Telephone;i.City=o[s].City;i.VendorMail=o[s].VendorMail;i.VenValidTo=o[s].VenValidTo;i.VenFrom=o[s].VenFrom;i.VenTimeLeft=o[s].VenTimeLeft;var n=o[s].Status;i.ResetValidity=o[s].ResetValidity;break}}var d="";var l="";var c="";var h="0";if(n==="SBF"){d="SCR";this.msg="Rejected successfully by Supply Chain"}else if(n==="SCA"){d="RBF";this.msg="Rejected successfully by Finance"}i.Status=d;i.VenLevel=l;i.VenApprovalPending=c;i.VenApprove=h;this.getView().getModel().update("/VenOnboard(Vendor='"+i.Vendor+"',VendorId="+this.vendorId+")",i,{success:()=>{t.success(this.msg,{onClose:()=>this.getData()})},error:e=>{r.hide();console.log(e)}})}})});