sap.ui.define(["./BaseController","sap/m/MessageBox","sap/m/MessageToast","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/FilterType","sap/ui/core/BusyIndicator","sap/ui/model/json/JSONModel","sap/m/Dialog","sap/m/Button","sap/m/Label","sap/m/library","sap/m/Text","sap/m/TextArea"],function(e,t,i,s,a,r,o,n,d,l,c,u,p,m){"use strict";var h=u.ButtonType;var g=u.DialogType;return e.extend("sp.fiori.onboarding.controller.List",{onInit:function(){this.getRouter().attachRoutePatternMatched(this.onRouteMatched,this);["createFromDateId","createToDateId"].forEach(e=>{this.byId(e).attachBrowserEvent("keypress",e=>e.preventDefault())})},onRouteMatched:function(e){if(e.getParameter("name")!=="list"){return}this.getView().setModel(new n([]),"FormData");this.getData()},getData:function(){o.show();setTimeout(()=>{this.getView().getModel().read("/VenOnboard",{urlParameters:{venfilter:true},success:e=>{e.results.map(e=>{e.StatusText=formatter.formatStatus(e.Status);e.createdAt=formatter.formatDate(e.createdAt);return e});var t={purchase:false,quality:false,coo:false,marketingdom:false,marketingexp:false,finance:false};var i=this.getView().getModel("AccessDetails").getData();var s=this.getView().getModel("UserApiDetails").getData();t.purchase=i.find(e=>e.email===s.email&&e.Access==="Purchase")?true:false;t.quality=i.find(e=>e.email===s.email&&e.Access==="Quality")?true:false;t.coo=i.find(e=>e.email===s.email&&e.Access==="COO")?true:false;t.marketingdom=i.find(e=>e.email===s.email&&e.Access==="Marketingdom")?true:false;t.marketingexp=i.find(e=>e.email===s.email&&e.Access==="Marketingexp")?true:false;t.finance=i.find(e=>e.email===s.email&&e.Access==="Finance")?true:false;if(t.purchase){t.appbtn="purchase"}else if(t.quality){t.appbtn="quality"}else if(t.coo){t.appbtn="coo"}else if(t.marketingdom){t.appbtn="marketingdom"}else if(t.marketingexp){t.appbtn="marketingexp"}else if(t.finance){t.appbtn="finance"}this.getView().getModel("request").setData(t);this.getView().getModel("request").refresh(true);this.getView().getModel("DataModel").setData(e.results);this.getView().getModel("DataModel").setSizeLimit(e.results.length);this.getView().getModel("DataModel").refresh(true);o.hide()},error:()=>o.hide()})},1e3)},onSelectAllData:function(){o.show();setTimeout(()=>{this.getView().getModel().read("/VenOnboard",{success:e=>{e.results.map(e=>{e.StatusText=formatter.formatStatus(e.Status);e.createdAt=formatter.formatDate(e.createdAt);return e});var t={purchase:false,quality:false,coo:false,marketingdom:false,marketingexp:false,finance:false,requestor:false};var i=this.getView().getModel("AccessDetails").getData();var s=this.getView().getModel("UserApiDetails").getData();t.purchase=i.find(e=>e.email===s.email&&e.Access==="Purchase")?true:false;t.quality=i.find(e=>e.email===s.email&&e.Access==="Quality")?true:false;t.coo=i.find(e=>e.email===s.email&&e.Access==="COO")?true:false;t.marketingdom=i.find(e=>e.email===s.email&&e.Access==="Marketingdom")?true:false;t.marketingexp=i.find(e=>e.email===s.email&&e.Access==="Marketingexp")?true:false;t.finance=i.find(e=>e.email===s.email&&e.Access==="Finance")?true:false;t.requestor=i.find(e=>e.email===s.email&&e.Access==="Requestor")?true:false;if(t.purchase){t.appbtn="purchase"}else if(t.quality){t.appbtn="quality"}else if(t.coo){t.appbtn="coo"}else if(t.marketingdom){t.appbtn="marketingdom"}else if(t.marketingexp){t.appbtn="marketingexp"}else if(t.finance){t.appbtn="finance"}this.getView().getModel("request").setData(t);this.getView().getModel("request").refresh(true);this.getView().getModel("DataModel").setData(e.results);this.getView().getModel("DataModel").setSizeLimit(e.results.length);this.getView().getModel("DataModel").refresh(true);o.hide()},error:()=>o.hide()})},1e3)},onDeselectAllData:function(){this.getData()},onSearch:function(e){var t=e.getParameter("query");if(e.getParameter("refreshButtonPressed")){this.getData()}else if(t){this.byId("createFromDateId").setValue("");this.byId("createToDateId").setValue("");this.byId("vendorList").getBinding("items").filter([new s([new s("Vendor",sap.ui.model.FilterOperator.Contains,t),new s("VendorName",sap.ui.model.FilterOperator.Contains,t),new s("Lifnr",sap.ui.model.FilterOperator.Contains,t),new s("VenApprovalPending",sap.ui.model.FilterOperator.Contains,t),new s("StatusText",sap.ui.model.FilterOperator.Contains,t)])])}else{this.byId("vendorList").getBinding("items").filter([])}},onCreationDateFilter:function(){var e=this.byId("createFromDateId").getValue(),t=this.byId("createToDateId").getValue();if(e&&t){this.byId("vendorList").getBinding("items").filter([new s([new s("createdAt",sap.ui.model.FilterOperator.BT,e,t)])])}else if(e){this.byId("vendorList").getBinding("items").filter([new s([new s("createdAt",sap.ui.model.FilterOperator.EQ,e)])])}else if(t){this.byId("vendorList").getBinding("items").filter([new s([new s("createdAt",sap.ui.model.FilterOperator.LE,t)])])}else{this.byId("vendorList").getBinding("items").filter([])}this.byId("search").setValue("")},onCreatePress:function(){var e=sap.ui.xmlfragment("sp.fiori.onboarding.fragment.Create",this);this.getView().addDependent(e);sap.ui.getCore().byId("createDialog").setModel(new n({}),"CreateModel");e.open()},onCreateSubmit:function(){if(this.validateFields()){o.show();const e=sap.ui.getCore().byId("createDialog").getModel("CreateModel").getData();e.Vendor=this.generateVendorNo();e.VenFrom=new Date;e.VenValidTo=this.changeDate(e.VenFrom,15,"add");e.initiatedBy=sessionStorage.getItem("userEmail");e.GroupType=e.GroupType.join(",");setTimeout(()=>{this.getView().getModel().create("/VenOnboard",e,{success:async e=>{o.hide();console.log("VendorId",e.VendorId);t.success("Vendor creation request "+e.Vendor+" created successfully. \n\n Also, Supplier form generated please fill to procced.",{onClose:()=>{sap.ui.getCore().byId("createDialog").destroy();this.getData()}});await this.sendEmailNotification(e.VendorName,e.VendorId,e.VendorMail,e.VenValidTo)},error:()=>o.hide()})},1e3)}else{t.error("Please correct all the error's to proceed")}},sendEmailNotification:function(e,t,i,s){let a=window.location.href.split("/")[2]+"/"+jQuery.sap.getModulePath("sp/fiori/onboarding").split("/")[1].split(".")[0]+".onboarding.spfiorisupplierform/index.html?id="+t;return new Promise((t,r)=>{let o=`||Please find the link below for Vendor Assessment Form. Kindly log-in with the link to fill the form.<br><br>Form is valid till ${s}. Request you to fill the form and submit on time.<br><br><a href=${a}>CLICK HERE</a>`;var n=this.getView().getModel();var d={method:"GET",urlParameters:{vendorName:e,subject:"Supplier Form",content:o,toAddress:i,ccAddress:sessionStorage.getItem("userEmail")},success:function(e,i){console.log("Email sent successfully.");t(e)},error:function(e){console.log("Failed to send email.");r(e)}};n.callFunction("/sendEmail",d)})},onFormPress:function(){const e=window.location.href;let t;if(e.includes("impautosuppdev")){t=jQuery.sap.getModulePath("sp/fiori/onboarding").split("/")[1].split(".")[0]+".onboarding.spfiorisupplierform/index.html?id="+this.vendorId}else{t="/supplierform/webapp/index.html?id="+this.vendorId}window.open(t)},onMoreInfoPress:function(e){e.getSource().getParent().getParent().destroy();this.getRouter().navTo("Form",{VendorId:this.vendorId})},onVendorPress:function(e){var t=e.getSource().getBindingContext("DataModel").getObject();var i=this.getView().getModel("request").getData();this.vendor=t.Vendor;this.vendorId=t.VendorId;if(i.purchase===true){t.Access="Purchase"}else if(i.quality===true){t.Access="Quality"}else if(i.coo===true){t.Access="COO"}else if(i.marketingdom===true){t.Access="Marketingdom"}else if(i.marketingexp===true){t.Access="Marketingexp"}else if(i.finance===true){t.Access="Finance"}else if(i.requestor===true){t.Access="Requestor"}var s=sap.ui.xmlfragment("sp.fiori.onboarding.fragment.VendorDetails",this);sap.ui.getCore().byId("displayPopover").setModel(new n(t),"VenModel");this.getView().addDependent(s);s.openBy(e.getSource())},onResetValidityPress:function(e){o.show();var i=e.getSource();var s=this.getView().getModel("DataModel").getData();var a={};for(var r=0;r<s.length;r++){if(s[r].VendorId===this.vendorId){a.Vendor=s[r].Vendor;a.VendorId=s[r].VendorId;a.VendorName=s[r].VendorName;a.VendorType=s[r].VendorType;a.Companycode=s[r].Companycode;a.RegistrationType=s[r].RegistrationType;a.Department=s[r].Department;a.Telephone=s[r].Telephone;a.City=s[r].City;a.VendorMail=s[r].VendorMail;a.VenFrom=new Date;a.VenValidTo=this.changeDate(a.VenFrom,15,"add");a.VenTimeLeft="";a.Status=s[r].Status;a.ResetValidity="";a.initiatedBy=s[r].initiatedBy;a.SupplierType=s[r].SupplierType;this.RVendorName=s[r].VendorName;this.RVendorMail=s[r].VendorMail;this.RVenValidTo=a.VenValidTo;break}}setTimeout(()=>{this.getView().getModel().update("/VenOnboard(Vendor='"+a.Vendor+"',VendorId="+this.vendorId+")",a,{success:()=>{o.hide();t.success("Form validity extended for next 15 days for vendor "+this.vendor,{onClose:()=>{i.getParent().getParent().destroy();this.getData()}});this.sendResetEmailNotification(this.RVendorName,this.vendorId,this.RVendorMail,this.RVenValidTo)},error:e=>{o.hide();console.log(e)}})},1e3)},sendResetEmailNotification:function(e,t,i,s){let a=window.location.href.split("/")[2]+"/"+jQuery.sap.getModulePath("sp/fiori/onboarding").split("/")[1].split(".")[0]+".onboarding.spfiorisupplierform/index.html?id="+t;let r=`||Please find the link below for Vendor Assessment Form. Kindly log-in with the link to fill the form.<br><br>Validity of the form is extended for next 15 days. Form is valid till ${s}. Request you to fill the form and submit on time.<br><br><a href=${a}>CLICK HERE</a>`;var o=this.getView().getModel();var n={method:"GET",urlParameters:{vendorName:e,subject:"Supplier Form",content:r,toAddress:i,ccAddress:""},success:function(e,t){console.log("Email sent successfully.")},error:function(e){console.log("Failed to send email.")}};o.callFunction("/sendEmail",n)},onAttachmentPress:function(e){o.show();var t=e.getSource();this.vendorId=t.getBindingContext("DataModel").getProperty("VendorId");setTimeout(()=>{this.getView().getModel().read("/Attachments",{filters:[new s("VendorId","EQ",this.vendorId)],success:e=>{e.results.map(e=>e.Url=this.getView().getModel().sServiceUrl+"/Attachments(VendorId='"+e.VendorId+"',ObjectId='"+e.ObjectId+"')/$value");var i=sap.ui.xmlfragment("sp.fiori.onboarding.fragment.Attachment",this);sap.ui.getCore().byId("attachPopover").setModel(new n(e),"AttachModel");this.getView().addDependent(i);i.openBy(t);sap.ui.getCore().byId("attachment").setUploadUrl(this.getView().getModel().sServiceUrl+"/Attachments");o.hide()},error:()=>o.hide()})},1e3)},onBeforeUploadStartsAttach:function(e){o.show();e.getParameters().addHeaderParameter(new sap.m.UploadCollectionParameter({name:"slug",value:this.vendorId+"/"+e.getParameters().fileName}))},getAttachments:function(){o.show();setTimeout(()=>{this.getView().getModel().read("/Attachments",{filters:[new s("VendorId","EQ",this.vendorId)],success:e=>{e.results.map(e=>e.Url=this.getView().getModel().sServiceUrl+"/Attachments(VendorId='"+e.VendorId+"',ObjectId='"+e.ObjectId+"')/$value");sap.ui.getCore().byId("attachPopover").setModel(new n(e),"AttachModel");o.hide()},error:()=>o.hide()})},1e3)},onAttachmentUploadComplete:function(e){if(e.getParameter("files")[0].status==201){i.show("File "+e.getParameter("files")[0].fileName+" Attached successfully");this.getAttachments()}else{t.error(JSON.parse(e.getParameter("files")[0].responseRaw).error.message.value);o.show()}},onAttachmentDeletePress:function(e){var i=e.getSource().getBindingContext("AttachModel").getObject();t.confirm("Are you sure ?",{actions:[t.Action.YES,t.Action.NO],onClose:e=>{if(e==="YES"){o.show();setTimeout(()=>{this.getView().getModel().remove("/Attachments(VendorId='"+i.VendorId+"',ObjectId='"+i.ObjectId+"')",{success:()=>{o.hide();t.success(i.Filename+" deleted successfully",{onClose:()=>this.getAttachments()})},error:()=>o.hide()})},1e3)}}})},delay:function(e){return new Promise(t=>setTimeout(t,e))},changeStatus:async function(){var e=this.getView().getModel("DataModel").getData();var i=this.getView().getModel("FormData").getData();var s=this.getView().getModel("request").getData();this.SupplierType=i.SupplierType;if(s.quality&&this.SupplierType==="Permanent"&&i.SystemAuditRating<"70"){t.error("The form cannot be approved as System Audit Rating is "+i.SystemAuditRating);return}else{o.show();var a={};for(var r=0;r<e.length;r++){if(e[r].VendorId===this.vendorId){a.Vendor=e[r].Vendor;a.VendorId=e[r].VendorId;a.VendorName=e[r].VendorName;a.VendorType=e[r].VendorType;a.Companycode=e[r].Companycode;a.RegistrationType=e[r].RegistrationType;a.Department=e[r].Department;a.Telephone=e[r].Telephone;a.City=e[r].City;a.VendorMail=e[r].VendorMail;this.VendorMail=e[r].VendorMail;a.VenValidTo=e[r].VenValidTo;a.VenFrom=e[r].VenFrom;a.VenTimeLeft=e[r].VenTimeLeft;a.initiatedBy=e[r].initiatedBy;this.initiatedBy=e[r].initiatedBy;var n=e[r].Status;a.ResetValidity=e[r].ResetValidity;a.SupplierType=e[r].SupplierType;var d=e[r].RegistrationType;break}}var l="";var c="";var u="";var p="0";var m=a.VendorName;let s=window.location.href.split("/index")[0].split(".onboarding")[0]+".onboarding.spfiorionboarding/index.html";if(n==="SBQ"){if(d==="Customer Driven (Domestic)"){c="4"}else if(d==="Customer Driven (Export)"){c="4"}else{c="3"}this.access="COO";this.emailbodyini=`||Form for the supplier ${m} is approved by the Quality. Approval pending at COO. `;this.emailbody=`||Form for the supplier ${m} is approved by the Quality. Approval pending at COO. Kindly submit and approve using below link.<br><br><a href=${s}>CLICK HERE</a>  `;this.VendorName="COO Team";l="ABQ";u="COO";this.msg="Approved by Quality"}else if(n==="SBP"){if(d==="Non BOM parts"){if(this.SupplierType==="Temporary"||this.SupplierType==="One Time"){this.access="Finance";this.emailbodyini=`||Form for the supplier ${m} is approved by the Purchase. Approval pending at Finance. `;this.emailbody=`||Form for the supplier ${m} is approved by the Purchase. Approval pending at Finance. Kindly submit and approve using below link.<br><br><a href=${s}>CLICK HERE</a>  `;this.VendorName="Finance Team";l="ABP";u="Finance";this.msg="Approved by Purchase";c="2"}else{c="2";this.access="COO";this.emailbodyini=`||Form for the supplier ${m} is approved by the Purchase. Approval pending at COO. `;this.emailbody=`||Form for the supplier ${m} is approved by the Purchase. Approval pending at COO. Kindly submit and approve using below link.<br><br><a href=${s}>CLICK HERE</a>  `;this.VendorName="COO Team";l="ABP";u="COO";this.msg="Approved by Purchase"}}else if(d==="Customer Driven (Domestic)"){if(this.SupplierType==="Temporary"||this.SupplierType==="One Time"){this.access="Finance";this.emailbodyini=`||Form for the supplier ${m} is approved by the Purchase. Approval pending at Finance. `;this.emailbody=`||Form for the supplier ${m} is approved by the Purchase. Approval pending at Finance. Kindly submit and approve using below link.<br><br><a href=${s}>CLICK HERE</a>  `;this.VendorName="Finance Team";l="ABP";u="Finance";this.msg="Approved by Purchase";c="2"}else{c="2";this.access="Marketingdom";this.emailbodyini=`||Form for the supplier ${m} is approved by the Purchase. Approval pending at Marketing. `;this.emailbody=`||Form for the supplier ${m} is approved by the Purchase. Approval pending at Marketing. Kindly submit and approve using below link.<br><br><a href=${s}>CLICK HERE</a>  `;this.VendorName="Marketing Team";l="ABP";u="Marketingdom";this.msg="Approved by Purchase"}}else if(d==="Customer Driven (Export)"){if(this.SupplierType==="Temporary"||this.SupplierType==="One Time"){this.access="Finance";this.emailbodyini=`||Form for the supplier ${m} is approved by the Purchase. Approval pending at Finance. `;this.emailbody=`||Form for the supplier ${m} is approved by the Purchase. Approval pending at Finance. Kindly submit and approve using below link.<br><br><a href=${s}>CLICK HERE</a>  `;this.VendorName="Finance Team";l="ABP";u="Finance";this.msg="Approved by Purchase";c="2"}else{c="2";this.access="Marketingexp";this.emailbodyini=`||Form for the supplier ${m} is approved by the Purchase. Approval pending at Marketing. `;this.emailbody=`||Form for the supplier ${m} is approved by the Purchase. Approval pending at Marketing. Kindly submit and approve using below link.<br><br><a href=${s}>CLICK HERE</a>  `;this.VendorName="Marketing Team";l="ABP";u="Marketingexp";this.msg="Approved by Purchase"}}else{if(this.SupplierType==="Temporary"||this.SupplierType==="One Time"){this.access="Finance";this.emailbodyini=`||Form for the supplier ${m} is approved by the Purchase. Approval pending at Finance. `;this.emailbody=`||Form for the supplier ${m} is approved by the Purchase. Approval pending at Finance. Kindly submit and approve using below link.<br><br><a href=${s}>CLICK HERE</a>  `;this.VendorName="Finance Team";l="ABP";u="Finance";this.msg="Approved by Purchase";c="2"}else{c="2";this.access="Quality";this.emailbodyini=`||Form for the supplier ${m} is approved by the Purchase. Approval pending at Quality. `;this.emailbody=`||Form for the supplier ${m} is approved by the Purchase. Approval pending at Quality. Kindly submit and approve using below link.<br><br><a href=${s}>CLICK HERE</a>  `;this.VendorName="Quality Team";l="ABP";u="Quality";this.msg="Approved by Purchase"}}}else if(n==="SBE"){this.access="Quality";this.emailbodyini=`||Form for the supplier ${m} is approved by the Marketing. Approval pending at Quality. `;this.emailbody=`||Form for the supplier ${m} is approved by the Marketing. Approval pending at Quality. Kindly submit and approve using below link.<br><br><a href=${s}>CLICK HERE</a>  `;this.VendorName="Quality Team";c="3";l="ABE";u="Quality";this.msg="Approved by Marketing"}else if(n==="SBC"){if(d==="Non BOM parts"){c="3"}else if(d==="Customer Driven (Domestic)"){c="5"}else if(d==="Customer Driven (Export)"){c="5"}else{c="4"}this.access="Finance";this.emailbodyini=`||Form for the supplier ${m} is approved by the COO. Approval pending at Finance. `;this.emailbody=`||Form for the supplier ${m} is approved by the COO. Approval pending at Finance. Kindly submit and approve using below link.<br><br><a href=${s}>CLICK HERE</a>  `;this.VendorName="Finance Team";l="ABC";u="Finance";this.msg="Approved by COO"}else if(n==="SBF"){this.access="Supplier";this.emailbodyini=`||Form for the supplier ${m} is approved by the Finance and BP created successfully. `;this.emailbody=`||Form for the supplier ${m} is approved by the Finance and BP created successfully. `;this.VendorName=a.VendorName;l="ABF";a.AddressCode=i.AddressCode;this.msg="Approved by Finance and BP created successfully"}a.Status=l;a.VenLevel=c;a.VenApprovalPending=u;a.VenApprove=p;this.initiateName="Initiator";this.getView().getModel().update("/VenOnboard(Vendor='"+a.Vendor+"',VendorId="+this.vendorId+")",a,{success:async()=>{await this.sendApprovalEmailNotification(this.emailbodyini,this.initiateName,this.initiatedBy);if(this.access!=="Supplier"){try{var e=await this.getEmails(this.access);for(const t of e){await this.sendApprovalEmailNotification(this.emailbody,this.VendorName,t);await this.delay(500)}}catch(e){console.error("Error fetching emails: ",e)}}else if(this.access==="Supplier"){this.sendApprovalEmailNotification(this.emailbody,this.VendorName,this.VendorMail)}o.hide();t.success(this.msg,{onClose:()=>this.getData()})},error:e=>{o.hide();console.log(e)}})}},sendApprovalEmailNotification:function(e,t,i){return new Promise((s,a)=>{var r=this.getView().getModel();var o={method:"GET",urlParameters:{vendorName:t,subject:"Supplier Form",content:e,toAddress:i,ccAddress:""},success:function(e,t){console.log("Email sent successfully.");s(e)},error:function(e){console.log("Failed to send email.");a(e)}};r.callFunction("/sendEmail",o)})},getEmails:async function(e){var t=this.getView().getModel();return new Promise((i,s)=>{t.read("/AccessInfo",{filters:[new sap.ui.model.Filter("Access",sap.ui.model.FilterOperator.EQ,e)],success:function(e){var t=e.results.map(e=>e.email);i(t)},error:function(e){s(e)}})})},getFormData:async function(){var e=this.getView().getModel("DataModel").getData();var t=this.getView().getModel("FormData").getData();var i=this.getView().getModel("UserApiDetails").getData();var s=[],a=0;s[a]={GstNumber:t.GstNumber,Address:t.Address1+" "+t.Address2,AddressCode:t.AddressCode};if(t.AdditionalGst===true){if(t.GstNumber1!==""&&t.GstNumber1!==null&&t.GstNumber1!==undefined){a=a+1;s[a]={GstNumber:t.GstNumber1,Address:t.Gst1Address1+" "+t.Gst1Address2,AddressCode:t.AddressCode1}}if(t.GstNumber2!==""&&t.GstNumber2!==null&&t.GstNumber2!==undefined){a=a+1;s[a]={GstNumber:t.GstNumber2,Address:t.Gst2Address1+" "+t.Gst2Address2,AddressCode:t.AddressCode2}}if(t.GstNumber3!==""&&t.GstNumber3!==null&&t.GstNumber3!==undefined){a=a+1;s[a]={GstNumber:t.GstNumber3,Address:t.Gst3Address1+" "+t.Gst3Address2,AddressCode:t.AddressCode3}}if(t.GstNumber4!==""&&t.GstNumber4!==null&&t.GstNumber4!==undefined){a=a+1;s[a]={GstNumber:t.GstNumber4,Address:t.Gst4Address1+" "+t.Gst4Address2,AddressCode:t.AddressCode4}}if(t.GstNumber5!==""&&t.GstNumber5!==null&&t.GstNumber5!==undefined){a=a+1;s[a]={GstNumber:t.GstNumber5,Address:t.Gst5Address1+" "+t.Gst5Address2,AddressCode:t.AddressCode5}}}if(t.ExciseDivision===null){t.ExciseDivision="-"}if(t.ExciseBankAcc===null){t.ExciseBankAcc="-"}if(t.STRatePerc===null){t.STRatePerc="0"}if(t.JWRWCost===null){t.JWRWCost="0"}if(t.ExciseRange===null){t.ExciseRange="0"}if(t.ExciseBankName===null){t.ExciseBankName="-"}if(t.STRateSurcharge===null){t.STRateSurcharge="0"}if(t.LSTNo===null){t.LSTNo="0"}if(t.GroupCode7===null){t.GroupCode7="/ /"}if(t.Fax===null){t.Fax=""}if(t.LeadTime===null){t.LeadTime=""}if(t.Remarks===null){t.Remarks=""}if(t.Designation===null){t.Designation=""}if(t.DeliveryMode===null){t.DeliveryMode=""}if(t.CustomerCat===null){t.CustomerCat=""}if(t.ExciseDivision===null){t.ExciseDivision=""}if(t.ExciseBankAcc===null){t.ExciseBankAcc=""}if(t.Tin===null){t.Tin=""}if(t.Composite===null){t.Composite=""}if(t.GstNumber===null){t.GstNumber=""}if(t.CreditRating===null){t.CreditRating=""}if(t.CreditRatingAgency===null){t.CreditRatingAgency=""}if(t.ServiceAccType===null){t.ServiceAccType=""}if(t.ECCNo===null){t.ECCNo=""}if(t.CSTDate===null){t.CSTDate=""}if(t.LSTDate===null){t.LSTDate=""}if(t.ExciseNo===null){t.ExciseNo=""}if(t.JWRWCost===null){t.JWRWCost=""}if(t.CompanyType===null){t.CompanyType=""}if(t.ISOExpiryDate===null){t.ISOExpiryDate=""}if(t.AddressType===null){t.AddressType=""}if(t.ExciseRange===null){t.ExciseRange=""}if(t.ExciseBankName===null){t.ExciseBankName=""}if(t.CinNo===null){t.CinNo=""}if(t.GstApplicable==="YES"){t.GstRegistered="1"}else{t.GstRegistered="0"}if(t.GSTDate===null){t.GSTDate=""}if(t.MsmeMainCertificateId===null){t.MsmeMainCertificateId=""}if(t.ServiceAccCode===null){t.ServiceAccCode=""}if(t.STRateSurcharge===null){t.STRateSurcharge=""}if(t.CSTNo===null){t.CSTNo=""}if(t.LSTNo===null){t.LSTNo=""}if(t.Pan===null){t.Pan=""}if(t.ExciseDate===null){t.ExciseDate=""}if(t.GroupingLocation===null){t.GroupingLocation=""}if(t.GroupCode5===null){t.GroupCode5=""}if(t.GroupCode4===null){t.GroupCode4=""}if(t.Transporters===null){t.Transporters=""}if(t.GroupCode8===null){t.GroupCode8=""}if(t.AccountNo===null){t.AccountNo=""}if(t.IFSCCode===null){t.IFSCCode=""}if(t.BeneficiaryName===null){t.BeneficiaryName=""}if(t.BankName===null){t.BankName=""}if(t.BankAddress===null){t.BankAddress=""}if(t.ExciseDuty===null){t.ExciseDuty="0"}if(t.MRPPercentage===null){t.MRPPercentage="0"}if(t.Distance===null){t.Distance="0"}if(t.Tax===null){t.Tax="-"}if(t.DocCode===null){t.DocCode=""}if(t.DocDescription===null){t.DocDescription=""}if(t.Address3===null){t.Address3=""}if(t.District===null){t.District=""}if(t.VendorName2===null){t.VendorName2=""}if(t.VendorName3===null){t.VendorName3=""}for(var r=0;r<s.length;r++){this.lastItem=false;if(r===s.length-1){this.lastItem=true}var o={SupplierType:t.SupplierType,UnitCode:"P01",AddressCode:s[r].AddressCode,AddressDesc:t.VendorName,vendorAddress:s[r].Address,AccountCode:t.AccountCode,AccountDesc:t.AccountDesc,FaxNo:t.Fax,ContactPerson:t.ContactPersonName,LeadTime:"",Remark:t.Remarks,IAIvendorCode:"",Country:t.Country_code,State:t.State_name,City:t.City_name,Location:t.Location,PinNo:t.Pincode,PhoneNumber:t.Telephone,Email:t.VendorMail,ContactPersonDesgn:t.ContactPersonDesignation,DeliveryMode:"",CustomerCategory:"",ExciseDivision:"-",ExciseBankAccount:"-",StRatePercent:"0",TinNo:t.Tin,Composite:"",GSTRegistartion:s[r].GstNumber,CreditRating:"",CreditRatingAgency:"",ServiceAccounType:"",ECCNo:"",CSTDate:t.CSTDate,LSTDate:t.LSTDate,ExciseNo:"",JswCost:"0",CompanyType:t.CompanyType,ISOExpiryDate:"",AddressType:t.AddressType,ExciseRange:"0",ExciseBankAccountName:"-",ExciseDuty:"0",CinNo:t.CinNo,GstRegistered:t.GstRegistered,GstDate:t.GSTDate,MSMEType:t.MsmeMainCertificateId,ServiceAccountCode:"",STRateSurCharge:"0",CSTNo:t.CSTNo,LSTNo:"0",PANNo:t.Pan,ExciseDate:"",MRPPercentage:"0",SalesPersonCode:"",DistanceKm:"0",TypeOfSupplier:"",PartyClassification:"Sup",GroupingLocation:t.GroupingLocation,GroupCode5:"",GroupCode7:"/ /",Tax:"-",GroupCode4:"",Transporters:"",GroupCode8:"",BankAccountNo:t.AccountNo,IFSCNo:t.IFSCCode,PayeeName:t.BeneficiaryName,BankName:t.BankName,BankAddress:t.BankAddress,Street:t.Address1,Street2:t.Address2,Street3:t.Address3,Street4:t.City_name,Street5:t.District,Customer:"",BPGrouping:t.BPGrouping,Name1:t.VendorName,Name2:t.VendorName2,Name3:t.VendorName3,PayTerms:t.SuppPaymentTerm,BankState:t.BankState_name,ContantInformation:[{ContactName:t.ContactPersonName,ContactDepartment:t.ContactPersonDepartment,ContactAddress:t.ContactPersonDesignation,ContactPhoneNo:t.ContactPersonPhone,ContactMobiloNo:t.ContactPersonMobile===null?"":t.ContactPersonMobile,ContactEmail:t.ContactPersonMail===null?"":t.ContactPersonMail,SNo:"1"}],DocumentRequired:[{DocumentCode:"",DocumentDescription:""}],TransMode:"",CreatedBy:this.getView().getModel().getHeaders().loginId,CreatedIP:"",UpdatedBy:""};if(sessionStorage.getItem("isunitaddressexists")===true){o.TransMode="EDIT";o.UpdatedBy=i.email}else{o.TransMode="ADD"}var n=JSON.stringify(o);this.AddressCode=s[r].AddressCode;await this.call(n);await this.delay(500)}},call:function(e){this.hardcodedURL="";if(window.location.href.includes("site")){this.hardcodedURL=jQuery.sap.getModulePath("sp.fiori.onboarding")}var i=this.hardcodedURL+`/v2/odata/v4/catalog/submitFormData`;return new Promise((s,a)=>{$.ajax({async:true,type:"POST",headers:{loginid:this.getView().getModel().getHeaders().loginId,"Content-Type":"application/json"},url:i,data:JSON.stringify({data:e}),context:this,success:function(e){t.success("Approved by Finance and BP "+e.d.submitFormData+" created successfully");if(this.lastItem===true){this.changeStatus()}s(e)}.bind(this),error:function(e){var i=JSON.parse(e.responseText);t.error(i.error.message.value);a(e)}})})},onApprPress:function(e){var t=this.getView().getModel("DataModel").getData();var i=e.getSource().getBindingContext("DataModel").sPath.split("/")[1];this.vendorId=t[i].VendorId;var s=t[i].Status;if(s==="SBF"){setTimeout(()=>{this.getView().getModel().read("/VendorForm(VendorId='"+this.vendorId+"')",{success:e=>{this.getView().getModel("FormData").setData(e);o.hide();this.getFormData()},error:()=>{o.hide()}})},1e3)}else{setTimeout(()=>{this.getView().getModel().read("/VendorForm(VendorId='"+this.vendorId+"')",{success:e=>{this.getView().getModel("FormData").setData(e);this.changeStatus()},error:()=>{o.hide()}})},1e3)}},onRejectPress:function(e){var t=this.getView().getModel("DataModel").getData();var i=e.getSource().getBindingContext("DataModel").sPath.split("/")[1];this.vendorId=t[i].VendorId;if(!this.oSubmitDialog){this.oSubmitDialog=new d({title:"Reject Form",type:g.Message,content:[new c({text:"Reason for Rejection",labelFor:"submissionNote"}),new m("submissionNote",{width:"100%",placeholder:"Add reason (required)",liveChange:function(e){var t=e.getParameter("value");this.RejReason=t;this.oSubmitDialog.getBeginButton().setEnabled(t.length>0)}.bind(this)})],beginButton:new l({type:h.Emphasized,text:"Reject",enabled:false,press:function(){this.oSubmitDialog.close();this.onRejPress()}.bind(this)}),endButton:new l({text:"Cancel",press:function(){this.oSubmitDialog.close()}.bind(this)})})}this.oSubmitDialog.open()},onRejPress:function(){var e=this;var i=this.getView().getModel("DataModel").getData();var s={};for(var a=0;a<i.length;a++){if(i[a].VendorId===this.vendorId){s.Vendor=i[a].Vendor;s.VendorId=i[a].VendorId;s.VendorName=i[a].VendorName;s.VendorType=i[a].VendorType;s.Companycode=i[a].Companycode;s.RegistrationType=i[a].RegistrationType;s.Department=i[a].Department;s.Telephone=i[a].Telephone;s.City=i[a].City;s.VendorMail=i[a].VendorMail;s.VenFrom=new Date;s.VenValidTo=this.changeDate(s.VenFrom,15,"add");s.VenTimeLeft=i[a].VenTimeLeft;s.initiatedBy=i[a].initiatedBy;var r=i[a].Status;s.ResetValidity=i[a].ResetValidity;s.SupplierType=i[a].SupplierType;s.RejReason=this.RejReason;var n=i[a].RegistrationType;var d=i[a].SupplierType;break}}var l="";var c="";var u="";var p="0";if(r==="SBP"){l="RBP";this.msg="Rejected successfully by Purchase Head"}else if(r==="SBQ"){u="Purchase";l="RBQ";c="1";this.msg="Rejected successfully by Quality"}else if(r==="SBC"){u="Purchase";l="RBC";c="1";this.msg="Rejected successfully by COO"}else if(r==="SBE"){u="Purchase";l="RBE";c="1";this.msg="Rejected successfully by Marketing"}else if(r==="SBF"){u="Purchase";l="RBF";c="1";this.msg="Rejected successfully by Finance"}s.Status=l;s.VenLevel=c;s.VenApprovalPending=u;s.VenApprove=p;this.VendorName=s.VendorName;this.VendorMail=s.VendorMail;this.VenValidTo=s.VenValidTo;this.venstatus=l;this.url=window.location.href.split("/")[2]+jQuery.sap.getModulePath("sp/fiori/onboarding").split("/")[1].split(".")[0]+".onboarding.spfiorisupplierform/index.html?id="+this.vendorId;this.getView().getModel().update("/VenOnboard(Vendor='"+s.Vendor+"',VendorId="+this.vendorId+")",s,{success:()=>{t.success(this.msg,{onClose:()=>this.getData()});if(e.venstatus==="RBP"){e.rejemail=`||The form is rejected due to the following reason ${e.RejReason} .Please find the link below for Vendor Assessment Form. Kindly log-in with the link to fill the form.<br><br>Form is valid till ${e.VenValidTo}. Request you to fill the form and submit on time.<br><br><a href=${e.url}>CLICK HERE</a>`;e.sendRejEmailNotification(e.rejemail,e.VendorName,e.vendorId,e.VendorMail,e.VenValidTo)}},error:e=>{o.hide();console.log(e)}})},sendRejEmailNotification:function(e,t,i,s,a){var r=this.getView().getModel();var o={method:"GET",urlParameters:{vendorName:t,subject:"Supplier Form",content:e,toAddress:s,ccAddress:""},success:function(e,t){console.log("Email sent successfully.")},error:function(e){console.log("Failed to send email.")}};r.callFunction("/sendEmail",o)}})});