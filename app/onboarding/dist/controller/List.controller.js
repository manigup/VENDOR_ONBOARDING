sap.ui.define(["./BaseController","sap/m/MessageBox","sap/m/MessageToast","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/FilterType","sap/ui/core/BusyIndicator","sap/ui/model/json/JSONModel"],function(e,t,i,a,o,n,s,r){"use strict";return e.extend("sp.fiori.onboarding.controller.List",{onInit:function(){this.getRouter().attachRoutePatternMatched(this.onRouteMatched,this);["createFromDateId","createToDateId"].forEach(e=>{this.byId(e).attachBrowserEvent("keypress",e=>e.preventDefault())})},onRouteMatched:function(e){if(e.getParameter("name")!=="list"){return}this.getView().setModel(new r([]),"FormData");this.getData()},getData:function(){s.show();setTimeout(()=>{this.getView().getModel().read("/VenOnboard",{success:e=>{e.results.map(e=>{e.StatusText=formatter.formatStatus(e.Status);e.WavStatusText=formatter.formatStatus(e.WavStatus);parseInt(e.Score);return e});var t={purchase:false,quality:false,coo:false,ceo:false,finance:false};var i=this.getView().getModel("AccessDetails").getData();var a=this.getView().getModel("UserApiDetails").getData();t.purchase=i.find(e=>e.email===a.email&&e.Access==="Purchase")?true:false;t.quality=i.find(e=>e.email===a.email&&e.Access==="Quality")?true:false;t.coo=i.find(e=>e.email===a.email&&e.Access==="COO")?true:false;t.ceo=i.find(e=>e.email===a.email&&e.Access==="CEO")?true:false;t.finance=i.find(e=>e.email===a.email&&e.Access==="Finance")?true:false;if(t.purchase){t.appbtn="purchase"}else if(t.quality){t.appbtn="quality"}else if(t.coo){t.appbtn="coo"}else if(t.ceo){t.appbtn="ceo"}else if(t.finance){t.appbtn="finance"}this.getView().getModel("request").setData(t);this.getView().getModel("request").refresh(true);this.getView().getModel("DataModel").setData(e.results);this.getView().getModel("DataModel").setSizeLimit(e.results.length);this.getView().getModel("DataModel").refresh(true);s.hide()},error:()=>s.hide()})},1e3)},onSearch:function(e){var t=e.getParameter("query");if(e.getParameter("refreshButtonPressed")){this.getData()}else if(t){this.byId("createFromDateId").setValue("");this.byId("createToDateId").setValue("");this.byId("vendorList").getBinding("items").filter([new a([new a("Vendor",sap.ui.model.FilterOperator.Contains,t),new a("VendorName",sap.ui.model.FilterOperator.Contains,t),new a("Lifnr",sap.ui.model.FilterOperator.Contains,t),new a("VenApprovalPending",sap.ui.model.FilterOperator.Contains,t),new a("StatusText",sap.ui.model.FilterOperator.Contains,t)])])}else{this.byId("vendorList").getBinding("items").filter([])}},onCreationDateFilter:function(){var e=this.byId("createFromDateId").getValue(),t=this.byId("createToDateId").getValue();if(e&&t){this.byId("vendorList").getBinding("items").filter([new a([new a("createdAt",sap.ui.model.FilterOperator.BT,e,t)])])}else if(e){this.byId("vendorList").getBinding("items").filter([new a([new a("createdAt",sap.ui.model.FilterOperator.EQ,e)])])}else if(t){this.byId("vendorList").getBinding("items").filter([new a([new a("createdAt",sap.ui.model.FilterOperator.LE,t)])])}else{this.byId("vendorList").getBinding("items").filter([])}this.byId("search").setValue("")},onCreatePress:function(){var e=sap.ui.xmlfragment("sp.fiori.onboarding.fragment.Create",this);this.getView().addDependent(e);sap.ui.getCore().byId("createDialog").setModel(new r({}),"CreateModel");e.open()},onCreateSubmit:function(){if(this.validateFields()){s.show();const e=sap.ui.getCore().byId("createDialog").getModel("CreateModel").getData();e.Vendor=this.generateVendorNo();e.VenFrom=new Date;e.VenValidTo=this.changeDate(e.VenFrom,7,"add");e.initiatedBy=sessionStorage.getItem("userEmail");setTimeout(()=>{this.getView().getModel().create("/VenOnboard",e,{success:e=>{s.hide();console.log("VendorId",e.VendorId);t.success("Vendor creation request "+e.Vendor+" created successfully. \n\n Also, Supplier form generated please fill to procced.",{onClose:()=>{sap.ui.getCore().byId("createDialog").destroy();this.getData()}});this.sendEmailNotification(e.VendorName,e.VendorId,e.VendorMail,e.VenValidTo)},error:()=>s.hide()})},1e3)}else{t.error("Please correct all the error's to proceed")}},sendEmailNotification:function(e,t,i,a){let o=`||Please find the link below for Vendor Assessment Form. Kindly log-in with the link to fill the form.<br><br>Form is valid till ${a}. Request you to fill the form and submit on time.<br><br><a href="https://impautosuppdev.launchpad.cfapps.ap10.hana.ondemand.com/da8bb600-97b5-4ae9-822d-e6aa134d8e1a.onboarding.spfiorisupplierform-0.0.1/index.html?id=${t}">CLICK HERE</a>`;var n=this.getView().getModel();var s={method:"GET",urlParameters:{vendorName:e,subject:"Supplier Form",content:o,toAddress:i},success:function(e,t){console.log("Email sent successfully.")},error:function(e){console.log("Failed to send email.")}};n.callFunction("/sendEmail",s)},onFormPress:function(){const e=window.location.href;let t;if(e.includes("impautosuppdev")){t="https://impautosuppdev.launchpad.cfapps.ap10.hana.ondemand.com/da8bb600-97b5-4ae9-822d-e6aa134d8e1a.onboarding.spfiorisupplierform-0.0.1/index.html?id="+this.vendorId}else{t="/supplierform/webapp/index.html?id="+this.vendorId}window.open(t)},onMoreInfoPress:function(e){e.getSource().getParent().getParent().destroy();this.getRouter().navTo("Form",{VendorId:this.vendorId})},onVendorPress:function(e){var t=e.getSource().getBindingContext("DataModel").getObject();var i=this.getView().getModel("request").getData();this.vendor=t.Vendor;this.vendorId=t.VendorId;if(i.purchase===true){t.Access="Purchase"}else if(i.quality===true){t.Access="Quality"}else if(i.coo===true){t.Access="COO"}else if(i.ceo===true){t.Access="CEO"}else if(i.finance===true){t.Access="Finance"}var a=sap.ui.xmlfragment("sp.fiori.onboarding.fragment.VendorDetails",this);sap.ui.getCore().byId("displayPopover").setModel(new r(t),"VenModel");this.getView().addDependent(a);a.openBy(e.getSource())},onResetValidityPress:function(e){s.show();var i=e.getSource();var a=this.getView().getModel("DataModel").getData();var o={};for(var n=0;n<a.length;n++){if(a[n].VendorId===this.vendorId){o.Vendor=a[n].Vendor;o.VendorId=a[n].VendorId;o.VendorName=a[n].VendorName;o.VendorType=a[n].VendorType;o.Companycode=a[n].Companycode;o.RegistrationType=a[n].RegistrationType;o.Department=a[n].Department;o.Telephone=a[n].Telephone;o.City=a[n].City;o.VendorMail=a[n].VendorMail;o.VenFrom=new Date;o.VenValidTo=this.changeDate(o.VenFrom,7,"add");o.VenTimeLeft="";o.Status=a[n].Status;o.ResetValidity="";o.initiatedBy=a[n].initiatedBy;o.RelatedPart=a[n].RelatedPart;break}}setTimeout(()=>{this.getView().getModel().update("/VenOnboard(Vendor='"+o.Vendor+"',VendorId="+this.vendorId+")",o,{success:()=>{s.hide();t.success("Form validity extended for next 7 days for vendor "+this.vendor,{onClose:()=>{i.getParent().getParent().destroy();this.getData()}})},error:e=>{s.hide();console.log(e)}})},1e3)},onAttachmentPress:function(e){s.show();var t=e.getSource();this.vendorId=t.getBindingContext("DataModel").getProperty("VendorId");setTimeout(()=>{this.getView().getModel().read("/Attachments",{filters:[new a("VendorId","EQ",this.vendorId)],success:e=>{e.results.map(e=>e.Url=this.getView().getModel().sServiceUrl+"/Attachments(VendorId='"+e.VendorId+"',ObjectId='"+e.ObjectId+"')/$value");var i=sap.ui.xmlfragment("sp.fiori.onboarding.fragment.Attachment",this);sap.ui.getCore().byId("attachPopover").setModel(new r(e),"AttachModel");this.getView().addDependent(i);i.openBy(t);sap.ui.getCore().byId("attachment").setUploadUrl(this.getView().getModel().sServiceUrl+"/Attachments");s.hide()},error:()=>s.hide()})},1e3)},onBeforeUploadStartsAttach:function(e){s.show();e.getParameters().addHeaderParameter(new sap.m.UploadCollectionParameter({name:"slug",value:this.vendorId+"/"+e.getParameters().fileName}))},getAttachments:function(){s.show();setTimeout(()=>{this.getView().getModel().read("/Attachments",{filters:[new a("VendorId","EQ",this.vendorId)],success:e=>{e.results.map(e=>e.Url=this.getView().getModel().sServiceUrl+"/Attachments(VendorId='"+e.VendorId+"',ObjectId='"+e.ObjectId+"')/$value");sap.ui.getCore().byId("attachPopover").setModel(new r(e),"AttachModel");s.hide()},error:()=>s.hide()})},1e3)},onAttachmentUploadComplete:function(e){if(e.getParameter("files")[0].status==201){i.show("File "+e.getParameter("files")[0].fileName+" Attached successfully");this.getAttachments()}else{t.error(JSON.parse(e.getParameter("files")[0].responseRaw).error.message.value);s.show()}},onAttachmentDeletePress:function(e){var i=e.getSource().getBindingContext("AttachModel").getObject();t.confirm("Are you sure ?",{actions:[t.Action.YES,t.Action.NO],onClose:e=>{if(e==="YES"){s.show();setTimeout(()=>{this.getView().getModel().remove("/Attachments(VendorId='"+i.VendorId+"',ObjectId='"+i.ObjectId+"')",{success:()=>{s.hide();t.success(i.Filename+" deleted successfully",{onClose:()=>this.getAttachments()})},error:()=>s.hide()})},1e3)}}})},changeStatus:function(){var e=this.getView().getModel("DataModel").getData();var i=this.getView().getModel("FormData").getData();var a={};for(var o=0;o<e.length;o++){if(e[o].VendorId===this.vendorId){a.Vendor=e[o].Vendor;a.VendorId=e[o].VendorId;a.VendorName=e[o].VendorName;a.VendorType=e[o].VendorType;a.Companycode=e[o].Companycode;a.RegistrationType=e[o].RegistrationType;a.Department=e[o].Department;a.Telephone=e[o].Telephone;a.City=e[o].City;a.VendorMail=e[o].VendorMail;this.VendorMail=e[o].VendorMail;a.VenValidTo=e[o].VenValidTo;a.VenFrom=e[o].VenFrom;a.VenTimeLeft=e[o].VenTimeLeft;a.initiatedBy=e[o].initiatedBy;this.initiatedBy=e[o].initiatedBy;var n=e[o].Status;a.ResetValidity=e[o].ResetValidity;a.RelatedPart=e[o].RelatedPart;var r=e[o].RelatedPart;break}}var d="";var l="";var c="";var u="0";if(n==="SBQ"){this.access="Purchase";this.emailbody=`||Form is approved by the Quality. Approval pending at Purchase `;this.VendorName="Purchase Team";d="ABQ";l="2";c="Purchase";this.msg="Approved by Quality"}else if(n==="SBP"){this.access="COO";this.emailbody=`||Form is approved by the Purchase. Approval pending at COO `;this.VendorName="COO Team";d="ABP";l="3";c="COO";this.msg="Approved by Purchase"}else if(n==="SBC"&&r==="No"){this.access="Finance";this.emailbody=`||Form is approved by the COO. Approval pending at Finance `;this.VendorName="Finance Team";d="ABC";l="4";c="Finance";this.msg="Approved by COO"}else if(n==="SBC"&&r==="Yes"){this.access="CEO";this.emailbody=`||Form is approved by the COO. Approval pending at CEO `;this.VendorName="CEO Team";d="ABC";l="4";c="CEO";this.msg="Approved by COO"}else if(n==="SBE"&&r==="Yes"){this.access="Finance";this.emailbody=`||Form is approved by the CEO. Approval pending at Finance `;this.VendorName="Finance Team";d="ABE";l="5";c="Finance";this.msg="Approved by CEO"}else if(n==="SBF"){this.access="Supplier";this.emailbody=`||Form is approved by the Finance and BP created successfully. `;this.VendorName=a.VendorName;d="ABF";a.AddressCode=i.AddressCode;this.msg="Approved by Finance and BP "+a.AddressCode+" created successfully"}a.Status=d;a.VenLevel=l;a.VenApprovalPending=c;a.VenApprove=u;this.initiateName="Initiator";this.getView().getModel().update("/VenOnboard(Vendor='"+a.Vendor+"',VendorId="+this.vendorId+")",a,{success:async()=>{s.hide();t.success(this.msg,{onClose:()=>this.getData()});this.sendApprovalEmailNotification(this.emailbody,this.initiateName,this.initiatedBy);if(this.access!=="Supplier"){try{var e=await this.getEmails(this.access);e.forEach(e=>{this.sendApprovalEmailNotification(this.emailbody,this.VendorName,e)})}catch(e){console.error("Error fetching emails: ",e)}}else if(this.access==="Supplier"){this.sendApprovalEmailNotification(this.emailbody,this.VendorName,this.VendorMail)}},error:e=>{s.hide();console.log(e)}})},sendApprovalEmailNotification:function(e,t,i){var a=this.getView().getModel();var o={method:"GET",urlParameters:{vendorName:t,subject:"Supplier Form",content:e,toAddress:i},success:function(e,t){console.log("Email sent successfully.")},error:function(e){console.log("Failed to send email.")}};a.callFunction("/sendEmail",o)},getEmails:async function(e){var t=this.getView().getModel();return new Promise((i,a)=>{t.read("/AccessInfo",{filters:[new sap.ui.model.Filter("Access",sap.ui.model.FilterOperator.EQ,e)],success:function(e){var t=e.results.map(e=>e.email);i(t)},error:function(e){a(e)}})})},getFormData:function(){var e=this.getView().getModel("DataModel").getData();var i=this.getView().getModel("FormData").getData();var a=this.getView().getModel("UserApiDetails").getData();if(i.ExciseDivision===null){i.ExciseDivision="-"}if(i.ExciseBankAcc===null){i.ExciseBankAcc="-"}if(i.STRatePerc===null){i.STRatePerc="0"}if(i.JWRWCost===null){i.JWRWCost="0"}if(i.ExciseRange===null){i.ExciseRange="0"}if(i.ExciseBankName===null){i.ExciseBankName="-"}if(i.STRateSurcharge===null){i.STRateSurcharge="0"}if(i.LSTNo===null){i.LSTNo="0"}if(i.GroupCode7===null){i.GroupCode7="/ /"}if(i.Fax===null){i.Fax=""}if(i.LeadTime===null){i.LeadTime=""}if(i.Remarks===null){i.Remarks=""}if(i.Designation===null){i.Designation=""}if(i.DeliveryMode===null){i.DeliveryMode=""}if(i.CustomerCat===null){i.CustomerCat=""}if(i.ExciseDivision===null){i.ExciseDivision=""}if(i.ExciseBankAcc===null){i.ExciseBankAcc=""}if(i.Tin===null){i.Tin=""}if(i.Composite===null){i.Composite=""}if(i.GstNumber===null){i.GstNumber=""}if(i.CreditRating===null){i.CreditRating=""}if(i.CreditRatingAgency===null){i.CreditRatingAgency=""}if(i.ServiceAccType===null){i.ServiceAccType=""}if(i.ECCNo===null){i.ECCNo=""}if(i.CSTDate===null){i.CSTDate=""}if(i.LSTDate===null){i.LSTDate=""}if(i.ExciseNo===null){i.ExciseNo=""}if(i.JWRWCost===null){i.JWRWCost=""}if(i.CompanyType===null){i.CompanyType=""}if(i.ISOExpiryDate===null){i.ISOExpiryDate=""}if(i.AddressType===null){i.AddressType=""}if(i.ExciseRange===null){i.ExciseRange=""}if(i.ExciseBankName===null){i.ExciseBankName=""}if(i.CinNo===null){i.CinNo=""}if(i.GstRegistered===null){i.GstRegistered=""}if(i.GSTDate===null){i.GSTDate=""}if(i.MsmeMainCertificateId===null){i.MsmeMainCertificateId=""}if(i.ServiceAccCode===null){i.ServiceAccCode=""}if(i.STRateSurcharge===null){i.STRateSurcharge=""}if(i.CSTNo===null){i.CSTNo=""}if(i.LSTNo===null){i.LSTNo=""}if(i.Pan===null){i.Pan=""}if(i.ExciseDate===null){i.ExciseDate=""}if(i.GroupingLocation===null){i.GroupingLocation=""}if(i.GroupCode5===null){i.GroupCode5=""}if(i.GroupCode4===null){i.GroupCode4=""}if(i.Transporters===null){i.Transporters=""}if(i.GroupCode8===null){i.GroupCode8=""}if(i.AccountNo===null){i.AccountNo=""}if(i.IFSCCode===null){i.IFSCCode=""}if(i.BeneficiaryName===null){i.BeneficiaryName=""}if(i.BankName===null){i.BankName=""}if(i.BankAddress===null){i.BankAddress=""}var o={SupplierType:i.SupplierType,UnitCode:sessionStorage.getItem("unitCode"),AddressCode:i.AddressCode,AddressDesc:i.VendorName,vendorAddress:i.Address1,AccountCode:i.AccountCode,AccountDesc:i.AccountDesc,FaxNo:i.Fax,ContactPerson:i.ContactPersonName,LeadTime:i.LeadTime,Remark:i.Remarks,IAIvendorCode:"",Country:i.Country_code,State:i.State_name,City:i.City_name,Location:i.Location,PinNo:i.Pincode,PhoneNumber:i.Telephone,Email:i.VendorMail,ContactPersonDesgn:i.ContactPersonDesignation,DeliveryMode:i.DeliveryMode,CustomerCategory:i.CustomerCat,ExciseDivision:i.ExciseDivision,ExciseBankAccount:i.ExciseBankAcc,StRatePercent:i.STRatePerc,TinNo:i.Tin,Composite:i.Composite,GSTRegistartion:i.GstNumber,CreditRating:i.CreditRating,CreditRatingAgency:i.CreditRatingAgency,ServiceAccounType:i.ServiceAccType,ECCNo:i.ECCNo,CSTDate:i.CSTDate,LSTDate:i.LSTDate,ExciseNo:i.ExciseNo,JswCost:i.JWRWCost,CompanyType:i.CompanyType,ISOExpiryDate:i.ISOExpiryDate,AddressType:i.AddressType,ExciseRange:i.ExciseRange,ExciseBankAccountName:i.ExciseBankName,ExciseDuty:i.ExciseDuty,CinNo:i.CinNo,GstRegistered:i.GstRegistered,GstDate:i.GSTDate,MSMEType:i.MsmeMainCertificateId,ServiceAccountCode:i.ServiceAccCode,STRateSurCharge:i.STRateSurcharge,CSTNo:i.CSTNo,LSTNo:i.LSTNo,PANNo:i.Pan,ExciseDate:i.ExciseDate,MRPPercentage:i.MRPPercentage,SalesPersonCode:"",DistanceKm:i.Distance,TypeOfSupplier:"",PartyClassification:i.PartyClassification,GroupingLocation:i.GroupingLocation,GroupCode5:i.GroupCode5,GroupCode7:i.GroupCode7,Tax:i.Tax,GroupCode4:i.GroupCode4,Transporters:i.Transporters,GroupCode8:i.GroupCode8,BankAccountNo:i.AccountNo,IFSCNo:i.IFSCCode,PayeeName:i.BeneficiaryName,BankName:i.BankName,BankAddress:i.BankAddress,ContantInformation:[{ContactName:i.ContactPersonName,ContactDepartment:i.ContactPersonDepartment,ContactAddress:i.ContactPersonDesignation,ContactPhoneNo:i.ContactPersonPhone,ContactMobiloNo:i.ContactPersonMobile,ContactEmail:i.ContactPersonMail,SNo:"1"},{ContactName:i.ContactPersonName2,ContactDepartment:i.ContactPersonDepartment2,ContactAddress:i.ContactPersonDesignation2,ContactPhoneNo:i.ContactPersonPhone2,ContactMobiloNo:i.ContactPersonMobile2,ContactEmail:i.ContactPersonMail2,SNo:"2"}],DocumentRequired:[{DocumentCode:i.DocCode,DocumentDescription:i.DocDescription}],TransMode:"",CreatedBy:"Manikandan",CreatedIP:"",UpdatedBy:""};if(sessionStorage.getItem("isunitaddressexists")===true){o.TransMode="EDIT";o.UpdatedBy=a.email}else{o.TransMode="ADD"}var n=JSON.stringify(o);this.hardcodedURL="";if(window.location.href.includes("launchpad")){this.hardcodedURL="https://impautosuppdev.launchpad.cfapps.ap10.hana.ondemand.com/da8bb600-97b5-4ae9-822d-e6aa134d8e1a.onboarding.spfiorionboarding-0.0.1"}var s=this.hardcodedURL+`/v2/odata/v4/catalog/submitFormData`;$.ajax({type:"POST",headers:{"Content-Type":"application/json"},url:s,data:JSON.stringify({data:n}),context:this,success:function(e,t,i){this.changeStatus()}.bind(this),error:function(e){t.success("BP creation failed")}})},onApprPress:function(e){var t=this.getView().getModel("DataModel").getData();var i=e.getSource().getBindingContext("DataModel").sPath.split("/")[1];this.vendorId=t[i].VendorId;var a=t[i].Status;if(a==="SBF"){setTimeout(()=>{this.getView().getModel().read("/VendorForm(VendorId='"+this.vendorId+"')",{success:e=>{this.getView().getModel("FormData").setData(e);s.hide();this.getFormData()},error:()=>{s.hide()}})},1e3)}else{setTimeout(()=>{this.getView().getModel().read("/VendorForm(VendorId='"+this.vendorId+"')",{success:e=>{this.getView().getModel("FormData").setData(e);this.changeStatus()},error:()=>{s.hide()}})},1e3)}},onRejPress:function(e){var i=this.getView().getModel("DataModel").getData();var a=e.getSource().getBindingContext("DataModel").sPath.split("/")[1];this.vendorId=i[a].VendorId;var o={};for(var n=0;n<i.length;n++){if(i[n].VendorId===this.vendorId){o.Vendor=i[n].Vendor;o.VendorId=i[n].VendorId;o.VendorName=i[n].VendorName;o.VendorType=i[n].VendorType;o.Companycode=i[n].Companycode;o.RegistrationType=i[n].RegistrationType;o.Department=i[n].Department;o.Telephone=i[n].Telephone;o.City=i[n].City;o.VendorMail=i[n].VendorMail;o.VenValidTo=i[n].VenValidTo;o.VenFrom=i[n].VenFrom;o.VenTimeLeft=i[n].VenTimeLeft;o.initiatedBy=i[n].initiatedBy;var r=i[n].Status;o.ResetValidity=i[n].ResetValidity;o.RelatedPart=i[n].RelatedPart;break}}var d="";var l="";var c="";var u="0";if(r==="SBQ"){d="RBQ";this.msg="Rejected successfully by Quality"}else if(r==="SBP"){d="RBP";l="1";c="Quality";this.msg="Rejected successfully by Purchase Head"}else if(r==="SBC"){d="RBC";l="1";c="Quality";this.msg="Rejected successfully by COO"}else if(r==="SBE"){d="RBE";l="1";c="Quality";this.msg="Rejected successfully by CEO"}else if(r==="SBF"){d="RBF";l="1";c="Quality";this.msg="Rejected successfully by Finance"}o.Status=d;o.VenLevel=l;o.VenApprovalPending=c;o.VenApprove=u;this.VendorName=o.VendorName;this.VendorMail=o.VendorMail;this.VenValidTo=o.VenValidTo;this.venstatus=d;this.getView().getModel().update("/VenOnboard(Vendor='"+o.Vendor+"',VendorId="+this.vendorId+")",o,{success:()=>{t.success(this.msg,{onClose:()=>this.getData()});if(this.venstatus==="RBQ"){this.sendEmailNotification(this.VendorName,this.vendorId,this.VendorMail,this.VenValidTo)}},error:e=>{s.hide();console.log(e)}})}})});