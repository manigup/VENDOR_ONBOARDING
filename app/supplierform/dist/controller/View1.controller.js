sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageBox","sap/ui/core/BusyIndicator","sap/ui/model/json/JSONModel","sap/m/Dialog","sap/m/DialogType","sap/m/Button","sap/m/ButtonType","sap/m/Input","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/SimpleType","sap/ui/model/ValidateException","sap/m/MessageToast"],function(e,t,a,i,s,r,o,n,d,l,u,c,h,p){"use strict";return e.extend("sp.fiori.supplierform.controller.View1",{onInit:function(){sap.ui.getCore().getMessageManager().registerObject(this.getView(),true);this.router=sap.ui.core.UIComponent.getRouterFor(this);this.router.attachRouteMatched(this.handleRouteMatched,this);this.createModel=new i;this.getView().setModel(this.createModel,"create");var e=this.byId("MsmeValidFrom");e.addEventDelegate({onAfterRendering:()=>{e.$().find("INPUT").attr("disabled",true).css("color","#ccc")}},e);this.byId("MsmeValidTo").attachBrowserEvent("keypress",e=>e.preventDefault());this.hardcodedURL="";if(window.location.href.includes("launchpad")){this.hardcodedURL="https://impautosuppdev.launchpad.cfapps.ap10.hana.ondemand.com/da8bb600-97b5-4ae9-822d-e6aa134d8e1a.onboarding.spfiorisupplierform-0.0.1"}this.initializeCountries()},handleRouteMatched:function(e){if(e.getParameter("name")!=="RouteView1"){return}this.id=jQuery.sap.getUriParameters().get("id");var t=this.getView().getModel("request").getData();var i=this.getView().getModel("create").getData();i.VendorId=this.id;i.Vendor=t.Vendor;if(t.VendorType==="DM"){i.MsmeItilView="MSME";this.byId("msmeItil").setSelectedIndex(0)}if(t.VendorType==="DM"){i.GstApplicable="YES"}this.createModel.setData(i);this.createModel.refresh(true);this.vendorId=t.VendorId;var s={VendorId:t.VendorId,VendorType:t.VendorType,VendorName:t.VendorName,VendorMail:t.VendorMail,Telephone:t.Telephone};var r=JSON.stringify(s);var o=this.hardcodedURL+`/v2/odata/v4/catalog/VendorForm('${s.VendorId}')`;$.ajax({type:"GET",contentType:"application/json",url:o,context:this,success:function(e,i,s){let r=e.d;if(s.status===200||s.status===204){console.log("Data upserted successfully.")}if(t.VendorType==="DM"){if(!r.GstApplicable){r.GstApplicable="YES"}if(!r.MsmeValidTo){r.MsmeValidTo="99991231"}}if(!r.Type){r.Type="MATERIAL"}if(!r.MsmeItilView&&t.VendorType==="DM"){r.MsmeItilView="MSME";this.byId("msmeItil").setSelectedIndex(0)}else if(r.MsmeItilView==="Non MSME"){this.byId("msmeItil").setSelectedIndex(1)}if(r.MsmeMainCertificate==="X"){this.byId("msmeCert").setSelected(true)}r.BeneficiaryName=t.VendorName;this.createModel.setData(r);this.createModel.refresh(true);if(r.Country){this.countryHelpSelect()}if(r.City){this.loadCities(r.Country_code,r.State_name)}this._setRadioButtons(r);a.hide()}.bind(this),error:function(e,t,i){a.hide();console.log("Upsert failed: ",i)}});this._showRemainingTime()},_showRemainingTime:function(){var e=this;var a=this.getView().getModel("request").getData();try{var i=parseInt(a.VenValidTo.match(/\/Date\((\d+)\+\d+\)\//)[1]);var s=new Date(i);var r=new Date;var o=setInterval(function(){r=new Date;e.distance=s-r;var i=Math.floor(e.distance/(1e3*60*60*24));var n=Math.floor(e.distance%(1e3*60*60*24)/(1e3*60*60));var d=Math.floor(e.distance%(1e3*60*60)/(1e3*60));var l=Math.floor(e.distance%(1e3*60)/1e3);a.VenTimeLeft=` ${i} Days ${n} Hours ${d} Minutes ${l} Seconds`;e.getView().getModel("request").refresh(true);e.getView().byId("idRemTime").setText(a.VenTimeLeft);if(e.distance<0){clearInterval(o);a.VenTimeLeft="EXPIRED";e.getView().getModel("request").refresh(true);t.error("Form expired");e.getView().byId("saveBtnId").setVisible(false);e.getView().byId("submitBtnId").setVisible(false)}},1e3)}catch(e){console.error("Error in calculating remaining time: ",e)}},_setRadioButtons:function(e){if(e.VendorType==="IP"){this.byId("venTypeRbId").setSelectedIndex(1)}else if(e.VendorType==="EM"){this.byId("venTypeRbId").setSelectedIndex(2)}if(e.Type==="SERVICE"){this.byId("typeRbId").setSelectedIndex(1)}if(e.Msme==="NO"){this.byId("msmeRbId").setSelectedIndex(1)}if(e.GstApplicable==="NO"){this.byId("gstRbId").setSelectedIndex(1)}},onVenNameChange:function(e){var t=this.createModel.getData();t.BeneficiaryName=e.getSource().getValue();this.createModel.refresh(true)},onRadioButtonSelect:function(e){var t=this.createModel.getData();var a=e.getParameter("id").substring(e.getParameter("id").lastIndexOf("-")+1);var i=e.getParameter("selectedIndex");switch(a){case"venTypeRbId":if(i===1){t.VendorType="IMPORT"}else if(i===2){t.VendorType="EMPLOYEE"}else{t.VendorType="DOMESTIC"}break;case"typeRbId":if(i===1){t.Type="SERVICE"}else{t.Type="MATERIAL"}break;case"gstRbId":if(i===1){t.GstApplicable="NO"}else{t.GstApplicable="YES"}break;case"msmeItil":if(i===0){t.MsmeItilView="MSME"}else{t.MsmeItilView="Non MSME"}break}this.createModel.refresh(true)},_mandatCheck:async function(){var e=this.createModel.getData();var t=this.getView().getModel("request").getData();var a=this.getView(),i=false;var s=[a.byId("venNameId"),a.byId("mobileId"),a.byId("purposeId"),a.byId("address1Id"),a.byId("accNoId"),a.byId("bankNameId"),a.byId("ifscId"),a.byId("branchNameId"),a.byId("benNameId"),a.byId("benLocId"),a.byId("address2Id"),a.byId("pincodeId"),a.byId("contactPersonId"),a.byId("contactPersonMobileId")];if(e.GstApplicable==="YES"){s.push(a.byId("gstId"));var r=this.getView().getModel();var o=e.GstNumber}var n=[a.byId("countryId"),a.byId("stateId"),a.byId("cityId"),a.byId("benAccTypeId")];if(e.MsmeItilView==="MSME"){s.push(a.byId("MsmeCertificateNo"));s.push(a.byId("MsmeValidFrom"));s.push(a.byId("MsmeRegistrationCity"));n.push(a.byId("MsmeCertificateId"))}if(e.VendorType==="IP"){n.push(a.byId("currId"))}if(e.VendorType==="DM"||e.VendorType==="EM"){s.push(a.byId("panId"))}s.forEach(function(e){i=this._validateInput(e)||i},this);n.forEach(function(e){i=this._validateSelect(e,i)||i},this);i=this._validateAttachments(i);if(e.MsmeItilView==="MSME"&&!a.byId("msmeCert").getSelected()){a.byId("msmeCert").setValueState("Error");i=true}return i},_validateInput:function(e){var t,a=e.getBinding("value");try{a.getType().validateValue(e.getValue());e.setValueState("None");t=false}catch(a){e.setValueState("Error");t=true}return t},initializeCountries:function(){console.log("Country initialization");var e=this.getView().byId("countryId");if(!e.getModel("countries")){this.loadCountries()}},loadCountries:function(){var e=this.getView().byId("countryId");var t=this.getOwnerComponent().getModel();var a="/Country";t.read(a,{success:function(t){var a=new sap.ui.model.json.JSONModel;a.setData({Countries:t.results});e.setModel(a,"countries");e.bindItems({path:"countries>/Countries",template:new sap.ui.core.Item({key:"{countries>code}",text:"{countries>code}"})})},error:function(e){console.log("Error",e);sap.m.MessageToast.show("Failed to load countries.")}})},countryHelpSelect:function(){var e=this.getView().byId("stateId");var t=this.getView().byId("countryId").getSelectedKey();if(t){e.setEnabled(true);this.loadStates(t)}else{e.setEnabled(false)}},loadStates:function(e){var t=this.getView().byId("stateId");var a=this.getOwnerComponent().getModel();var i="/States";a.read(i,{urlParameters:{country:e},success:function(e){var a=new sap.ui.model.json.JSONModel;a.setData({States:e.results});t.setModel(a,"states");t.bindItems({path:"states>/States",template:new sap.ui.core.Item({key:"{states>name}",text:"{states>name}"})})},error:function(e){console.log("Error",e);sap.m.MessageToast.show("Failed to load states.")}})},handleStatePress:function(){var e=this.getView().byId("stateId");if(e.getSelectedKey()){var t=this.getView().byId("countryId").getSelectedKey();var a=e.getSelectedKey();this.loadCities(t,a)}else{p.show("Please select a state first.")}},loadCities:function(e,t){var a=this.getView().byId("cityId");var i=this.getOwnerComponent().getModel();var s="/City";i.read(s,{urlParameters:{country:e,state:t},success:function(e){var t=new sap.ui.model.json.JSONModel;t.setData({Cities:e.results});a.setModel(t,"cities");a.bindItems({path:"cities>/Cities",template:new sap.ui.core.Item({key:"{cities>name}",text:"{cities>name}"})})},error:function(e){console.log("Error",e);sap.m.MessageToast.show("Failed to load cities.")}})},_validateSelect:function(e,t){var a="None";var i=e.getSelectedKey();try{if(!i){oBinding.getType().validateValue(e.getValue())}}catch(e){a="Error";t=true}e.setValueState(a);return t},_validateAttachments:function(e){var t=this.createModel.getData();if(t.VendorType==="DM"||t.VendorType==="IP"){if(this.byId("quotfileUploader").getValue()||t.NewVendorQuotationName){this.byId("quotfileUploader").setValueState("None")}else{e=true;this.byId("quotfileUploader").setValueState("Error")}}if(t.VendorType==="DM"||t.VendorType==="IP"){if(this.byId("cocFileUploader").getValue()||t.CocName){this.byId("cocFileUploader").setValueState("None")}else{e=true;this.byId("cocFileUploader").setValueState("Error")}}if(t.VendorType==="IP"||t.VendorType==="EM"||t.MsmeItilView==="Non MSME"||this.byId("msmefileUploader").getValue()||t.MsmeDeclarationName){this.byId("msmefileUploader").setValueState("None")}else{e=true;this.byId("msmefileUploader").setValueState("Error")}if(t.VendorType==="DM"||t.VendorType==="EM"){if(this.byId("panfileUploader").getValue()||t.PanName){this.byId("panfileUploader").setValueState("None")}else{e=true;this.byId("panfileUploader").setValueState("Error")}}if(t.GstApplicable==="YES"){if(this.byId("gstfileUploader").getValue()||t.GstFileName){this.byId("gstfileUploader").setValueState("None")}else{e=true;this.byId("gstfileUploader").setValueState("Error")}}if(this.byId("canChqfileUploader").getValue()||t.CancelledCheque){this.byId("canChqfileUploader").setValueState("None")}else{e=true;this.byId("canChqfileUploader").setValueState("Error")}if(t.VendorType==="DM"||t.VendorType==="IP"){if(this.byId("quotfileUploader").getValue()||t.CancelledCheque){this.byId("quotfileUploader").setValueState("None")}else{e=true;this.byId("quotfileUploader").setValueState("Error")}if(this.byId("cocFileUploader").getValue()||t.CancelledCheque){this.byId("cocFileUploader").setValueState("None")}else{e=true;this.byId("cocFileUploader").setValueState("Error")}}return e},onInputChange:function(e,t){this.createModel.getData()[t]=e.getParameter("newValue");this.createModel.refresh},onSavePress:function(e){var i=this.createModel.getData();var s=this.getView().getModel("request").getData();i.VendorName=s.VendorName;i.Telephone=s.Telephone;i.VendorType=s.VendorType;i.VendorMail=s.VendorMail;i.BeneficiaryName=s.VendorName;var r=JSON.stringify(i);this.draft=true;a.show();var o=this.hardcodedURL+`/v2/odata/v4/catalog/VendorForm('${this.vendorId}')`;$.ajax({type:"PUT",contentType:"application/json",url:o,data:r,context:this,success:function(e,i,s){a.hide();t.success("Form data saved successfully",{onClose:()=>{this.changeStatus()}})}.bind(this),error:function(e,t,i){a.hide()}})},onSubmitPress:async function(e){var i=this;var s=await this._mandatCheck();if(!s){var r=this.createModel.getData();var o=this.getView().getModel("request").getData();var n=this.getView().getModel();i.otp=i.getOTP();i.otpTime=(new Date).getTime();var d={method:"GET",urlParameters:{vendorName:o.VendorName,subject:"OTP",content:`||OTP for submit vendor on-boarding form is ${i.otp}. | Do not share this with anyone. ImperialAuto will never telephone you to verify it.`,toAddress:o.VendorMail},success:function(e,t){i._enterOTP()},error:function(e){t.error("Failed to send OTP. Please try again.")}};n.callFunction("/sendEmail",d)}else{a.hide();if(s){t.information("Kindly fill all the required details")}}},_enterOTP:function(){var e=this;var i=sap.ui.getCore();let l=this.createModel.getData();var u=this.getView().getModel("request").getData();l.VendorName=u.VendorName;l.Telephone=u.Telephone;l.VendorType=u.VendorType;l.VendorMail=u.VendorMail;l.vendorId=u.vendorId;l.BeneficiaryName=u.VendorName;if(!this.oSubmitDialog){this.oSubmitDialog=new s({type:r.Message,title:"Enter the OTP Received ",content:[new d("submissionNote",{width:"100%",placeholder:"Enter OTP",liveChange:function(e){var t=e.getParameter("value");this.oSubmitDialog.getButtons()[0].setEnabled(t.length>=6)}.bind(this)})],buttons:[new o({type:n.Emphasized,text:"Submit",enabled:false,press:function(){var e=(new Date).getTime();var s=e-this.otpTime;var r=i.byId("submissionNote").getValue();if(s<=3e5&&r===this.otp){a.show();l.Otp=r;var o=JSON.stringify(l);var n=this.hardcodedURL+`/v2/odata/v4/catalog/VendorForm('${l.VendorId}')`;$.ajax({type:"PUT",contentType:"application/json",url:n,data:o,context:this,success:function(e,i,s){a.hide();if(s.status===200||s.status===204){t.success("Form submitted successfully",{onClose:()=>{this.changeStatus()}})}}.bind(this),error:function(e,t,i){console.log("Error: ",e,t,i);a.hide()}});i.byId("submissionNote").setValue();this.oSubmitDialog.close()}else{i.byId("submissionNote").setValue();if(s>6e4){t.error("OTP has expired")}else{t.error("Incorrect OTP")}}}.bind(this)}),new o({text:"Resend OTP",press:function(){this.onSubmitPress();this.oSubmitDialog.close()}.bind(this)}),new o({type:n.Reject,text:"Cancel",press:function(){this.oSubmitDialog.close()}.bind(this)})]})}this.oSubmitDialog.open()},onFileUploaderChange:function(e){var a=e.getSource();a.setUploadUrl(this.getView().getModel().sServiceUrl+"/Attachments");var i=a.getCustomData()[0].getKey();a.addHeaderParameter(new sap.ui.unified.FileUploaderParameter({name:"slug",value:this.vendorId+"/"+a.getValue()+"/"+i}));a.checkFileReadable().then(()=>{a.upload()},()=>{t.information("The file cannot be read. It may have changed.")})},onUploadComplete:function(e){if(e.getParameters().status!==201){t.error(JSON.parse(e.getParameters().responseRaw).error.message.value)}else{var a=e.getParameters().fileName;var i=e.getSource().getCustomData()[0].getKey();var s=this.createModel.getData();s[i]=a;this.createModel.setData(s);p.show("File "+a+" Attached successfully")}},onFileSizeExceded:function(e){t.error("File size exceeds the range of 5MB");e.getSource().setValueState("Error")},onAttachmentGet:function(e){var t=e.getSource().getCustomData()[0].getKey();a.show();setTimeout(()=>{var e=[new sap.ui.model.Filter("VendorId",sap.ui.model.FilterOperator.EQ,this.vendorId),new sap.ui.model.Filter("Venfiletype",sap.ui.model.FilterOperator.EQ,t)];var i=new sap.ui.model.Filter({filters:e,and:true});this.getView().getModel().read("/Attachments",{filters:[i],success:e=>{var t=e.results[0];var i=this.getView().getModel().sServiceUrl+"/Attachments(VendorId='"+t.VendorId+"',ObjectId='"+t.ObjectId+"')/$value";window.open(i,"_blank");a.hide()},error:()=>a.hide()})},1e3)},onMainCertificateChange:function(e){if(e.getParameter("selected")){this.createModel.setProperty("/MsmeMainCertificate","X")}else{this.createModel.setProperty("/MsmeMainCertificate","")}this.createModel.refresh(true)},getOTP:function(){var e=Math.floor(1e5+Math.random()*9e5).toString();return e},changeStatus:function(){var e=this.getView().getModel("request").getData();var t="";if(this.draft){if(e.Status==="INITIATED"||e.Status==="SAD"){this.draft=false;t="SAD"}}else{if(e.Status==="INITIATED"||e.Status==="SAD"||e.Status==="SRE-ROUTE"||e.Status==="SCR"){t="SBS"}else if(e.Status==="SBS"){t="SBC"}else if(e.Status==="SBF"){t="SBF"}}var a=e;a.Status=t;var i=JSON.stringify(a);var s=this.hardcodedURL+`/v2/odata/v4/catalog/VenOnboard(Vendor='${e.Vendor}',VendorId=${e.VendorId})`;$.ajax({type:"PUT",contentType:"application/json",url:s,data:i,context:this,success:function(e,t,a){if(a.status===200||a.status===204){console.log("Data upserted successfully.");window.location.reload()}}.bind(this),error:function(e,t,a){console.log("Upsert failed: ",a)}})},customPanType:c.extend("Pan",{formatValue:function(e){return e},parseValue:function(e){return e},validateValue:function(e){var t=/^([a-zA-Z]){5}([0-9]){4}([a-zA-Z]){1}?$/;if(!e.match(t)){throw new h("'"+e+"' is not a valid PAN Number")}}}),customGstType:c.extend("Gst",{formatValue:function(e){return e},parseValue:function(e){return e},validateValue:function(e){var t=/^[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}Z[0-9A-Z]{1}$/;if(!e.match(t)){throw new h("'"+e+"' is not a valid GST Number")}}}),customAccountType:c.extend("accountno",{formatValue:function(e){return e},parseValue:function(e){return e},validateValue:function(e){var t=/^[a-zA-Z0-9]+$/;if(!e.match(t)){throw new h("'"+e+"' is not a valid Account Number")}}})})});