sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageBox","sap/ui/core/BusyIndicator","sap/ui/model/json/JSONModel","sap/m/Dialog","sap/m/DialogType","sap/m/Button","sap/m/ButtonType","sap/m/Input","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/SimpleType","sap/ui/model/ValidateException"],function(e,t,a,i,r,s,o,n,l,d,u,c,h){"use strict";return e.extend("sp.fiori.supplierform.controller.View1",{onInit:function(){sap.ui.getCore().getMessageManager().registerObject(this.getView(),true);this.router=sap.ui.core.UIComponent.getRouterFor(this);this.router.attachRouteMatched(this.handleRouteMatched,this);this.createModel=new i({Otp:"",Werks:"",VenSubType:"DM",Type:"MATERIAL",VenName:"",Purpose:"",Consitution:"",VendorCategory:"",Pan:"",Address1:"",Address2:"",Address3:"",Country:"",State:"",Pincode:"",ContactPerson:"",Mobile:"",Email:"",Landline:"",Fax:"",Website:"",ProductName:"",PaymentTerm:"",GstApplicable:"",ImportExportCode:"",Remarks:"",Currency:"",VAT:"",NameOfService:"",AvailableServiceName:"",NameOfParts:"",AvailablePartsName:"",Others:"",GstNumber:""});this.getView().setModel(this.createModel,"create");var e=this.byId("MsmeValidFrom");e.addEventDelegate({onAfterRendering:()=>{e.$().find("INPUT").attr("disabled",true).css("color","#ccc")}},e);this.byId("MsmeValidTo").attachBrowserEvent("keypress",e=>e.preventDefault())},handleRouteMatched:function(e){if(e.getParameter("name")!=="RouteView1"){return}var t=this.getView().getModel("request").getData();this.id=jQuery.sap.getUriParameters().get("id");setTimeout(()=>{this.getView().getModel().read("/VendorFormSet(Reqnr='"+this.id+"',PropertyName=' ')",{success:e=>{if(t.VenSubType==="DM"){if(!e.GstApplicable){e.GstApplicable="YES"}if(!e.MsmeValidTo){e.MsmeValidTo="99991231"}}if(!e.Type){e.Type="MATERIAL"}if(!e.MsmeItilView&&e.VenSubType==="DM"){e.MsmeItilView="MSME";this.byId("msmeItil").setSelectedIndex(0)}else if(e.MsmeItilView==="Non MSME"){this.byId("msmeItil").setSelectedIndex(1)}if(e.MsmeMainCertificate==="X"){this.byId("msmeCert").setSelected(true)}e.BeneficiaryName=e.VenName;this.createModel.setData(e);this.createModel.refresh(true);if(e.Country){this.countryHelpSelect()}this._setRadioButtons(e);a.hide()},error:()=>{a.hide()}})},1e3)},_showRemainingTime:function(){var e=this;var a=this.getView().getModel("request").getData();var i=a.Date.substring(0,4);var r=parseInt(a.Date.substring(4,6))-1;var s=a.Date.substring(6,8);var o=a.Time.substring(0,2);var n=a.Time.substring(2,4);var l=a.Time.substring(4,6);var d=new Date(i,r,s,o,n,l,"00");var u=a.SDate.substring(0,4);var c=parseInt(a.SDate.substring(4,6))-1;var h=a.SDate.substring(6,8);var m=a.STime.substring(0,2);var p=a.STime.substring(2,4);var b=a.STime.substring(4,6);var f=new Date(u,c,h,m,p,b,"00");var I=setInterval(function(){d=new Date(d-1e3);e.distance=d-f;var i=Math.floor(e.distance/(1e3*60*60*24));var r=Math.floor(e.distance%(1e3*60*60*24)/(1e3*60*60));var s=Math.floor(e.distance%(1e3*60*60)/(1e3*60));var o=Math.floor(e.distance%(1e3*60)/1e3);a.time=i+" Days "+r+" hours "+s+" minute "+o+" seconds ";e.getView().getModel("request").refresh(true);if(e.distance<0){clearInterval(I);a.time="EXPIRED";e.getView().getModel("request").refresh(true);t.error("Form expired");e.getView().byId("saveBtnId").setVisible(false);e.getView().byId("submitBtnId").setVisible(false);return}},1e3)},_setRadioButtons:function(e){if(e.VenSubType==="IP"){this.byId("venTypeRbId").setSelectedIndex(1)}else if(e.VenSubType==="EM"){this.byId("venTypeRbId").setSelectedIndex(2)}if(e.Type==="SERVICE"){this.byId("typeRbId").setSelectedIndex(1)}if(e.Msme==="NO"){this.byId("msmeRbId").setSelectedIndex(1)}if(e.GstApplicable==="NO"){this.byId("gstRbId").setSelectedIndex(1)}},onVenNameChange:function(e){var t=this.createModel.getData();t.BeneficiaryName=e.getSource().getValue();this.createModel.refresh(true)},onRadioButtonSelect:function(e){var t=this.createModel.getData();var a=e.getParameter("id").substring(e.getParameter("id").lastIndexOf("-")+1);var i=e.getParameter("selectedIndex");switch(a){case"venTypeRbId":if(i===1){t.VenSubType="IMPORT"}else if(i===2){t.VenSubType="EMPLOYEE"}else{t.VenSubType="DOMESTIC"}break;case"typeRbId":if(i===1){t.Type="SERVICE"}else{t.Type="MATERIAL"}break;case"gstRbId":if(i===1){t.GstApplicable="NO"}else{t.GstApplicable="YES"}break;case"msmeItil":if(i===0){t.MsmeItilView="MSME"}else{t.MsmeItilView="Non MSME"}break}this.createModel.refresh(true)},_mandatCheck:function(){var e=this.createModel.getData();var t=this.getView().getModel("request").getData();var a=this.getView(),i=false;var r=[a.byId("venNameId"),a.byId("mobileId"),a.byId("purposeId"),a.byId("address1Id"),a.byId("accNoId"),a.byId("bankNameId"),a.byId("ifscId"),a.byId("branchNameId"),a.byId("benNameId"),a.byId("benLocId"),a.byId("address2Id"),a.byId("pincodeId"),a.byId("contactPersonId"),a.byId("contactPersonMobileId")];if(e.GstApplicable==="YES"){r.push(a.byId("gstId"))}var s=[a.byId("constId"),a.byId("countryId"),a.byId("stateId"),a.byId("benAccTypeId")];if(e.MsmeItilView==="MSME"){r.push(a.byId("MsmeCertificateNo"));r.push(a.byId("MsmeValidFrom"));r.push(a.byId("MsmeRegistrationCity"));s.push(a.byId("MsmeCertificateId"))}if(t.VenSubType==="IP"){s.push(a.byId("currId"))}if(t.VenSubType==="DM"||t.VenSubType==="EM"){r.push(a.byId("panId"))}r.forEach(function(e){i=this._validateInput(e)||i},this);s.forEach(function(e){i=this._validateSelect(e,i)||i},this);i=this._validateAttachments(i);if(e.MsmeItilView==="MSME"&&!a.byId("msmeCert").getSelected()){a.byId("msmeCert").setValueState("Error");i=true}return i},_validateInput:function(e){var t,a=e.getBinding("value");try{a.getType().validateValue(e.getValue());e.setValueState("None");t=false}catch(a){e.setValueState("Error");t=true}return t},countryHelpSelect:function(e){var t=this.getView().byId("countryId").getSelectedKey();this.getView().byId("stateId").getBinding("items").filter([new d({path:"Land1",operator:u.EQ,value1:t})])},_validateSelect:function(e,t){var a="None";var i=e.getSelectedKey();try{if(!i){oBinding.getType().validateValue(e.getValue())}}catch(e){a="Error";t=true}e.setValueState(a);return t},_validateAttachments:function(e){var t=this.createModel.getData();if(t.VenSubType==="DM"||t.VenSubType==="IP"){if(this.byId("quotfileUploader").getValue()||t.NewVendorQuotationName){this.byId("quotfileUploader").setValueState("None")}else{e=true;this.byId("quotfileUploader").setValueState("Error")}}if(t.VenSubType==="DM"||t.VenSubType==="IP"){if(this.byId("cocFileUploader").getValue()||t.CocName){this.byId("cocFileUploader").setValueState("None")}else{e=true;this.byId("cocFileUploader").setValueState("Error")}}if(t.VenSubType==="IP"||t.VenSubType==="EM"||t.MsmeItilView==="Non MSME"||this.byId("msmefileUploader").getValue()||t.MsmeDeclarationName){this.byId("msmefileUploader").setValueState("None")}else{e=true;this.byId("msmefileUploader").setValueState("Error")}if(t.VenSubType==="DM"||t.VenSubType==="EM"){if(this.byId("panfileUploader").getValue()||t.PanName){this.byId("panfileUploader").setValueState("None")}else{e=true;this.byId("panfileUploader").setValueState("Error")}}if(t.GstApplicable==="YES"){if(this.byId("gstfileUploader").getValue()||t.GstFileName){this.byId("gstfileUploader").setValueState("None")}else{e=true;this.byId("gstfileUploader").setValueState("Error")}}if(this.byId("canChqfileUploader").getValue()||t.CancelledCheque){this.byId("canChqfileUploader").setValueState("None")}else{e=true;this.byId("canChqfileUploader").setValueState("Error")}return e},onInputChange:function(e,t){this.createModel.getData()[t]=e.getParameter("newValue");this.createModel.refresh},onSavePress:function(e){var i=this.createModel.getData();a.show();setTimeout(()=>{this.getView().getModel().update("/VendorFormSet(Reqnr='"+this.id+"',PropertyName=' ')",i,{headers:{"x-csrf-token":this.csrf_token},success:()=>{a.hide();t.success("Form data saved successfully",{onClose:()=>window.location.reload()})},error:()=>{a.hide()}})},1e3)},onSubmitPress:function(e){var i=this;var r=this._mandatCheck();if(!r){var s=this.createModel.getData();var o=this.getView().getModel("request").getData();if(s.VenSubType==="DM"&&s.GstApplicable==="YES"&&s.Pan!==s.GstNumber.substr(2,10)){t.error("Invalid GSTIN Number. GSTIN does not matches with entered PAN No.");return}a.show();setTimeout(()=>{this.getView().getModel().read("/OTPGetSet(Reqnr='"+this.id+"')",{success:e=>{this.otp=e.Otp;t.information("To submit the data, kindly enter the OTP received on "+o.VenMail,{onClose:()=>this._enterOTP()});a.hide()},error:()=>{a.hide()}})},1e3)}else{t.information("Kindly fill all the required details")}},_enterOTP:function(){var e=this;var i=sap.ui.getCore();var d=this.createModel.getData();if(!this.oSubmitDialog){this.oSubmitDialog=new r({type:s.Message,title:"Enter the OTP Received on your Email",content:[new l("submissionNote",{width:"100%",placeholder:"Enter OTP",liveChange:function(e){var t=e.getParameter("value");this.oSubmitDialog.getButtons()[0].setEnabled(t.length>=6)}.bind(this)})],buttons:[new o({type:n.Emphasized,text:"Submit",enabled:false,press:function(){var e=i.byId("submissionNote").getValue();if(e===this.otp){a.show();d.Otp=e;setTimeout(()=>{this.getView().getModel().update("/VendorFormSet(Reqnr='"+this.id+"',PropertyName=' ')",d,{success:()=>{a.hide();t.success("Form submitted successfully",{onClose:()=>window.location.reload()})},error:()=>{a.hide()}})},1e3);i.byId("submissionNote").setValue();this.oSubmitDialog.close()}else{i.byId("submissionNote").setValue();t.error("Incorrect OTP")}}.bind(this)}),new o({text:"Resend OTP",press:function(){this.onSubmitPress();this.oSubmitDialog.close()}.bind(this)}),new o({type:n.Reject,text:"Cancel",press:function(){this.oSubmitDialog.close()}.bind(this)})]})}this.oSubmitDialog.open()},onFileUploaderChange:function(e){var i=e.getSource();i.setUploadUrl(this.getView().getModel().sServiceUrl+"/VendorFormSet");a.show();var r=i.getCustomData()[0].getKey();i.removeAllHeaderParameters();i.addHeaderParameter(new sap.ui.unified.FileUploaderParameter({name:"slug",value:this.id+"/"+r+"/"+i.getValue()}));i.checkFileReadable().then(()=>{i.upload()},()=>{t.information("The file cannot be read. It may have changed.")})},onUploadComplete:function(e){if(e.getParameter("status")!==201){e.getSource().setValue("");const a=e.getParameter("response");if(a){t.error(a.split(".")[0].split("022")[1]||a)}else{t.error("Error while uploading file")}}else{t.success("File "+e.getSource().getValue()+" uploaded successfully");e.getSource().setValueState("None")}a.hide()},onFileSizeExceded:function(e){t.error("File size exceeds the range of 5MB");e.getSource().setValueState("Error")},onAttachmentGet:function(e){var t=e.getSource().getCustomData()[0].getKey();sap.m.URLHelper.redirect(this.getView().getModel().sServiceUrl+"/VendorFormSet(Reqnr='"+this.id+"',PropertyName='"+t+"')/$value",true)},onMainCertificateChange:function(e){if(e.getParameter("selected")){this.createModel.setProperty("/MsmeMainCertificate","X")}else{this.createModel.setProperty("/MsmeMainCertificate","")}this.createModel.refresh(true)},customPanType:c.extend("Pan",{formatValue:function(e){return e},parseValue:function(e){return e},validateValue:function(e){var t=/^([a-zA-Z]){5}([0-9]){4}([a-zA-Z]){1}?$/;if(!e.match(t)){throw new h("'"+e+"' is not a valid PAN Number")}}}),customGstType:c.extend("Gst",{formatValue:function(e){return e},parseValue:function(e){return e},validateValue:function(e){var t=/^[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}Z[0-9A-Z]{1}$/;if(!e.match(t)){throw new h("'"+e+"' is not a valid GST Number")}}}),customAccountType:c.extend("accountno",{formatValue:function(e){return e},parseValue:function(e){return e},validateValue:function(e){var t=/^[a-zA-Z0-9]+$/;if(!e.match(t)){throw new h("'"+e+"' is not a valid Account Number")}}})})});